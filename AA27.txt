is_last = False
if '_is_last_of_group' in df.columns:
    is_last = bool(df.iloc[i]['_is_last_of_group'])






import pandas as pd
import numpy as np
import xlsxwriter
from datetime import datetime

# =====================================================
# CONFIG
# =====================================================
output_file = "DEC_2025_MARKETS_FINAL.xlsx"
counter = False
extra_rows_config = []   # unchanged, supported if needed

# =====================================================
# Helper
# =====================================================
def safe_div(n, d):
    return np.where(d == 0, np.nan, n / d)

# =====================================================
# Last completed month
# =====================================================
today = datetime.today()
report_month = "Dec" if today.month == 1 else datetime(today.year, today.month - 1, 1).strftime("%b")

# =====================================================
# STEP 1: Prepare df1 (Individual)
# =====================================================
df1_prep = df1.rename(columns={
    'Markets Products': 'Function',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

cols = ['term_hc', 'noti_hc']
df1_prep[cols] = (
    df1_prep[cols]
        .astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
)

df1_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['term_terms'], df1_prep['term_hc'])

df1_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['noti_terms'], df1_prep['noti_hc'])

df1_prep['Month'] = report_month

# =====================================================
# STEP 2: Prepare df2 (TOTAL)
# =====================================================
df2_prep = df2.rename(columns={
    'Total Markets Products': 'Officer Title Group',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

df2_prep[cols] = (
    df2_prep[cols]
        .astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
)

df2_prep['Function'] = df2_prep['Officer Title Group'].str.replace(r'^Total\s+', '', regex=True)

df2_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['term_terms'], df2_prep['term_hc'])

df2_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['noti_terms'], df2_prep['noti_hc'])

df2_prep['Month'] = report_month

# =====================================================
# STEP 3: Build df3
# =====================================================
blocks = []

for func in sorted(df1_prep['Function'].unique()):
    blocks.append(
        df1_prep[df1_prep['Function'] == func]
    )
    blocks.append(
        df2_prep[df2_prep['Function'] == func]
    )

df3 = pd.concat(blocks, ignore_index=True)

# =====================================================
# STEP 4: Final column order
# =====================================================
df3 = df3.rename(columns={
    'term_terms': 'Term Date - YTD Terms Vol',
    'term_hc': 'Term Date - YTD HC Avg',
    'term_ann': 'Term Date - YTD Ann Attrition',
    'noti_terms': 'Notification - YTD Terms',
    'noti_hc': 'Notification - YTD HC Avg',
    'noti_ann': 'Notification - YTD Ann Attrition'
})

final_cols = [
    'Function',
    'Officer Title Group',
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Term Date - YTD Ann Attrition',
    'Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg',
    'Notification - YTD Ann Attrition',
    'Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Month',
    'Year YTD'
]

df3 = df3[final_cols]

# =====================================================
# ðŸ”‘ CRITICAL SORT (FIXES YOUR ISSUE)
# =====================================================
df3 = df3.sort_values(
    by=['Function', 'Officer Title Group', 'Year YTD'],
    ascending=[True, True, True]
).reset_index(drop=True)

# =====================================================
# ðŸ”‘ GROUP END FLAG (THE REAL FIX)
# =====================================================
df3['_grp_key'] = (
    df3['Function'].astype(str) + '||' +
    df3['Officer Title Group'].astype(str)
)

df3['_is_last_of_group'] = (
    df3['_grp_key'] != df3['_grp_key'].shift(-1)
)

# =====================================================
# Excel column indexes
# =====================================================
TERM_TERMS_COL = 2
TERM_HC_COL = 3
TERM_NON_ANN_COL = 5
NOTI_TERMS_COL = 6
NOTI_HC_COL = 7
NOTI_NON_ANN_COL = 9

# =====================================================
# WRITE EXCEL
# =====================================================
def write_sheet(writer, sheet_name, df):
    workbook = writer.book
    worksheet = workbook.add_worksheet(sheet_name)
    writer.sheets[sheet_name] = worksheet

    header_fmt = workbook.add_format({
        'bold': True, 'border': 1, 'align': 'center', 'valign': 'vcenter'
    })
    normal_fmt = workbook.add_format({
        'border': 1, 'align': 'center', 'valign': 'vcenter'
    })
    thick_fmt = workbook.add_format({
        'bottom': 2, 'align': 'center', 'valign': 'vcenter'
    })
    pct_fmt = workbook.add_format({
        'num_format': '0.0%', 'align': 'center', 'valign': 'vcenter'
    })

    # Headers
    for c, col in enumerate(df.columns):
        worksheet.write(0, c, col, header_fmt)
        worksheet.set_column(c, c, 22)

    # Rows
    for i in range(len(df)):
        row = i + 1
        is_last = df.iloc[i]['_is_last_of_group']

        for c in range(len(df.columns)):
            val = df.iloc[i, c]
            fmt = thick_fmt if is_last else normal_fmt
            worksheet.write(row, c, "" if pd.isna(val) else val, fmt)

        # Non-annualized formulas
        worksheet.write_formula(
            row, TERM_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{row+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{row+1},0)',
            pct_fmt
        )

        worksheet.write_formula(
            row, NOTI_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{row+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{row+1},0)',
            pct_fmt
        )

    worksheet.freeze_panes(1, 0)

# =====================================================
# WRITE FILE
# =====================================================
with pd.ExcelWriter(
    output_file,
    engine="xlsxwriter",
    engine_kwargs={"options": {"nan_inf_to_errors": True}}
) as writer:

    write_sheet(writer, "All Product", df3)

    df4_clean = df4.replace([np.inf, -np.inf], "").fillna("")
    df4_clean.to_excel(writer, sheet_name="GOC_Summary", index=False)

    for f in df3['Function'].unique():
        write_sheet(
            writer,
            str(f)[:31],
            df3[df3['Function'] == f].reset_index(drop=True)
        )

print("âœ… DONE â€” Output matches approved format exactly")



















import pandas as pd
import numpy as np
import xlsxwriter
from datetime import datetime

# =====================================================
# CONFIG
# =====================================================
counter = False
extra_rows_config = []

output_file = "DEC_2025_MARKETS_FINAL.xlsx"

# =====================================================
# Helper
# =====================================================
def safe_div(n, d):
    return np.where(d == 0, np.nan, n / d)

# =====================================================
# Last completed month
# =====================================================
today = datetime.today()
report_month = "Dec" if today.month == 1 else datetime(today.year, today.month - 1, 1).strftime("%b")

# =====================================================
# CLEAN NUMERIC WITH COMMAS
# =====================================================
def clean_numeric(df, cols):
    df[cols] = (
        df[cols]
        .astype(str)
        .replace({',': ''}, regex=True)
        .replace({'nan': np.nan})
        .apply(pd.to_numeric, errors='coerce')
    )
    return df

# =====================================================
# PREP DF1
# =====================================================
df1_prep = df1.rename(columns={
    'Markets Products': 'Function',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

df1_prep = clean_numeric(df1_prep, ['term_hc', 'noti_hc'])

df1_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = safe_div(
    df1_prep['term_terms'], df1_prep['term_hc']
)
df1_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = safe_div(
    df1_prep['noti_terms'], df1_prep['noti_hc']
)

df1_prep['Month'] = report_month

# =====================================================
# PREP DF2 (TOTAL)
# =====================================================
df2_prep = df2.rename(columns={
    'Total Markets Products': 'Officer Title Group',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

df2_prep = clean_numeric(df2_prep, ['term_hc', 'noti_hc'])

df2_prep['Function'] = df2_prep['Officer Title Group'].str.replace(r'^Total\s+', '', regex=True)

df2_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = safe_div(
    df2_prep['term_terms'], df2_prep['term_hc']
)
df2_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = safe_div(
    df2_prep['noti_terms'], df2_prep['noti_hc']
)

df2_prep['Month'] = report_month

# =====================================================
# BUILD DF3
# =====================================================
blocks = []
for func in sorted(df1_prep['Function'].unique()):
    blocks.append(df1_prep[df1_prep['Function'] == func].sort_values(['Officer Title Group', 'Year YTD']))
    blocks.append(df2_prep[df2_prep['Function'] == func].sort_values('Year YTD'))

df3 = pd.concat(blocks, ignore_index=True)

# =====================================================
# FINAL COLUMNS
# =====================================================
df3 = df3.rename(columns={
    'term_terms': 'Term Date - YTD Terms Vol',
    'term_hc': 'Term Date - YTD HC Avg',
    'term_ann': 'Term Date - YTD Ann Attrition',
    'noti_terms': 'Notification - YTD Terms',
    'noti_hc': 'Notification - YTD HC Avg',
    'noti_ann': 'Notification - YTD Ann Attrition'
})

final_cols = [
    'Function',
    'Officer Title Group',
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Term Date - YTD Ann Attrition',
    'Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg',
    'Notification - YTD Ann Attrition',
    'Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Month',
    'Year YTD'
]
df3 = df3[final_cols]

# =====================================================
# EXCEL COLUMN INDEXES
# =====================================================
OFFICER_COL = 1
TERM_TERMS_COL = 2
TERM_HC_COL = 3
TERM_NON_ANN_COL = 5
NOTI_TERMS_COL = 6
NOTI_HC_COL = 7
NOTI_NON_ANN_COL = 9

# =====================================================
# WRITE SHEET WITH CORRECT BORDER LOGIC
# =====================================================
def write_sheet(writer, name, df):
    wb = writer.book
    ws = wb.add_worksheet(name)
    writer.sheets[name] = ws

    header = wb.add_format({'bold': True, 'border': 1, 'align': 'center', 'valign': 'vcenter'})
    normal = wb.add_format({'border': 1, 'align': 'center', 'valign': 'vcenter'})
    thick  = wb.add_format({'top': 2, 'align': 'center', 'valign': 'vcenter'})
    pct1   = wb.add_format({'num_format': '0.0%', 'border': 1, 'align': 'center'})
    pct2   = wb.add_format({'num_format': '0.00%', 'border': 1, 'align': 'center'})

    # Header
    for c, col in enumerate(df.columns):
        ws.write(0, c, col, header)
        ws.set_column(c, c, 22)

    total_rows = len(df)

    for i in range(total_rows):
        row = i + 1
        curr = df.iloc[i]
        next_row = df.iloc[i+1] if i < total_rows - 1 else None

        officer_end = next_row is None or curr['Officer Title Group'] != next_row['Officer Title Group']

        for c, val in enumerate(curr):
            fmt = normal
            if officer_end and c >= OFFICER_COL:
                fmt = thick

            if pd.isna(val) or val in [np.inf, -np.inf]:
                ws.write(row, c, "", fmt)
            else:
                ws.write(row, c, val, fmt)

        # Non-annualized formulas (single decimal %)
        ws.write_formula(
            row, TERM_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{row+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{row+1},0)',
            pct1
        )

        ws.write_formula(
            row, NOTI_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{row+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{row+1},0)',
            pct1
        )

    ws.freeze_panes(1, 0)

# =====================================================
# WRITE EXCEL
# =====================================================
with pd.ExcelWriter(
    output_file,
    engine="xlsxwriter",
    engine_kwargs={"options": {"nan_inf_to_errors": True}}
) as writer:

    write_sheet(writer, "All Product", df3)

    # GOC Summary
    df4_clean = df4.replace([np.inf, -np.inf], "").fillna("")
    write_sheet(writer, "GOC_Summary", df4_clean)

    # Function tabs
    for f in df3['Function'].unique():
        write_sheet(writer, str(f)[:31], df3[df3['Function'] == f])

print("âœ… FINAL FILE CREATED â€” borders EXACTLY as requested")



























import pandas as pd
import numpy as np
import xlsxwriter
from datetime import datetime

# =====================================================
# CONFIG
# =====================================================
output_file = "DEC_2025_MARKETS_FINAL.xlsx"

# Optional future hook (kept but inactive)
counter = False
extra_rows_config = []

# =====================================================
# Helper
# =====================================================
def safe_div(n, d):
    return np.where(d == 0, np.nan, n / d)

# =====================================================
# Month logic
# =====================================================
today = datetime.today()
if today.month == 1:
    report_month = "Dec"
    month_factor = 12 / 12
else:
    report_month = datetime(today.year, today.month - 1, 1).strftime("%b")
    month_factor = 12 / (today.month - 1)

# =====================================================
# STEP 1: Prepare df1 (Individual)
# =====================================================
df1_prep = df1.rename(columns={
    'Markets Products': 'Function',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

# Clean comma-separated HC columns
for c in ['term_hc', 'noti_hc']:
    df1_prep[c] = (
        df1_prep[c]
        .astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df1_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['term_terms'], df1_prep['term_hc'])

df1_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['noti_terms'], df1_prep['noti_hc'])

df1_prep['Month'] = report_month

# =====================================================
# STEP 2: Prepare df2 (TOTAL)
# =====================================================
df2_prep = df2.rename(columns={
    'Total Markets Products': 'Officer Title Group',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

for c in ['term_hc', 'noti_hc']:
    df2_prep[c] = (
        df2_prep[c]
        .astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df2_prep['Function'] = df2_prep['Officer Title Group'].str.replace(r'^Total\s+', '', regex=True)

df2_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['term_terms'], df2_prep['term_hc'])

df2_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['noti_terms'], df2_prep['noti_hc'])

df2_prep['Month'] = report_month

# =====================================================
# STEP 3: Build df3
# =====================================================
blocks = []

for func in sorted(df1_prep['Function'].unique()):
    blocks.append(
        df1_prep[df1_prep['Function'] == func]
        .sort_values(['Officer Title Group', 'Year YTD'])
    )
    blocks.append(
        df2_prep[df2_prep['Function'] == func]
        .sort_values('Year YTD')
    )

df3 = pd.concat(blocks, ignore_index=True)

# =====================================================
# STEP 4: Final columns
# =====================================================
df3 = df3.rename(columns={
    'term_terms': 'Term Date - YTD Terms Vol',
    'term_hc': 'Term Date - YTD HC Avg',
    'term_ann': 'Term Date - YTD Ann Attrition',
    'noti_terms': 'Notification - YTD Terms',
    'noti_hc': 'Notification - YTD HC Avg',
    'noti_ann': 'Notification - YTD Ann Attrition'
})

final_cols = [
    'Function',
    'Officer Title Group',
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Term Date - YTD Ann Attrition',
    'Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg',
    'Notification - YTD Ann Attrition',
    'Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Month',
    'Year YTD'
]

df3 = df3[final_cols]

# =====================================================
# Excel column indexes
# =====================================================
TERM_TERMS_COL = 2
TERM_HC_COL = 3
TERM_ANN_COL = 4
TERM_NON_ANN_COL = 5
NOTI_TERMS_COL = 6
NOTI_HC_COL = 7
NOTI_ANN_COL = 8
NOTI_NON_ANN_COL = 9

# =====================================================
# WRITE SHEET FUNCTION (FIXED & SAFE)
# =====================================================
def write_sheet(writer, sheet_name, df):
    workbook = writer.book
    ws = workbook.add_worksheet(sheet_name)
    writer.sheets[sheet_name] = ws

    header = workbook.add_format({'bold': True, 'border': 1, 'align': 'center', 'valign': 'vcenter'})
    thin   = workbook.add_format({'border': 1, 'align': 'center', 'valign': 'vcenter'})
    thick  = workbook.add_format({'top': 2, 'align': 'center', 'valign': 'vcenter'})
    pct2   = workbook.add_format({'num_format': '0.00%', 'border': 1, 'align': 'center', 'valign': 'vcenter'})
    pct1   = workbook.add_format({'num_format': '0.0%',  'border': 1, 'align': 'center', 'valign': 'vcenter'})

    rows, cols = df.shape
    has_function = 'Function' in df.columns

    # Headers
    for c, col in enumerate(df.columns):
        ws.write(0, c, col, header)
        ws.set_column(c, c, 22)

    # Rows
    for i in range(rows):
        for c in range(cols):
            val = df.iloc[i, c]
            if pd.isna(val) or val in [np.inf, -np.inf]:
                ws.write_blank(i+1, c, None, thin)
            else:
                ws.write(i+1, c, val, thin)

        # Non-annualized formulas (1 decimal)
        ws.write_formula(
            i+1, TERM_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+2}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+2},0)',
            pct1
        )

        ws.write_formula(
            i+1, NOTI_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+2}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+2},0)',
            pct1
        )

        # Officer separator ONLY
        if has_function and i > 0:
            prev = df.iloc[i-1]
            curr = df.iloc[i]

            if (
                prev['Function'] == curr['Function']
                and prev['Officer Title Group'] != curr['Officer Title Group']
            ):
                for c in range(1, cols):
                    ws.write_blank(i+1, c, None, thick)

    ws.freeze_panes(1, 0)

# =====================================================
# WRITE EXCEL
# =====================================================
with pd.ExcelWriter(
    output_file,
    engine="xlsxwriter",
    engine_kwargs={"options": {"nan_inf_to_errors": True}}
) as writer:

    write_sheet(writer, "All Product", df3)

    # GOC Summary (no Function logic)
    df4_clean = df4.replace([np.inf, -np.inf], "").fillna("")
    write_sheet(writer, "GOC_Summary", df4_clean)

    for f in df3['Function'].unique():
        write_sheet(writer, str(f)[:31], df3[df3['Function'] == f])

print("âœ… FINAL FILE GENERATED SUCCESSFULLY")






has_function_col = 'Function' in df.columns

if has_function_col and i < rows:
    curr_func = df.iloc[i-1]['Function']
    next_func = df.iloc[i]['Function']
    curr_off  = df.iloc[i-1]['Officer Title Group']
    next_off  = df.iloc[i]['Officer Title Group']

    if curr_func == next_func and curr_off != next_off:
        for c in range(OFF_COL, len(df.columns)):
            ws.write_blank(i + 1, c, None, bold_line)



import pandas as pd
import numpy as np
import xlsxwriter
from datetime import datetime

# =====================================================
# Helper
# =====================================================
def safe_div(n, d):
    return np.where(d == 0, np.nan, n / d)

# =====================================================
# Reporting Month & Annualization
# =====================================================
today = datetime.today()
if today.month == 1:
    report_month = "Dec"
    month_num = 12
else:
    report_month = datetime(today.year, today.month - 1, 1).strftime("%b")
    month_num = today.month - 1

annualization_factor = 12 / month_num

# =====================================================
# STEP 1: Prepare df1 (Individual)
# =====================================================
df1_prep = df1.rename(columns={
    'Markets Products': 'Function',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

for c in ['term_hc', 'noti_hc']:
    df1_prep[c] = (
        df1_prep[c].astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df1_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['term_terms'], df1_prep['term_hc'])

df1_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['noti_terms'], df1_prep['noti_hc'])

df1_prep['Month'] = report_month

# =====================================================
# STEP 2: Prepare df2 (TOTAL)
# =====================================================
df2_prep = df2.rename(columns={
    'Total Markets Products': 'Officer Title Group',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

for c in ['term_hc', 'noti_hc']:
    df2_prep[c] = (
        df2_prep[c].astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df2_prep['Function'] = df2_prep['Officer Title Group'].str.replace(
    r'^Total\s+', '', regex=True
)

df2_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['term_terms'], df2_prep['term_hc'])

df2_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['noti_terms'], df2_prep['noti_hc'])

df2_prep['Month'] = report_month

# =====================================================
# STEP 3: Build df3
# =====================================================
blocks = []
for func in sorted(df1_prep['Function'].unique()):
    blocks.append(
        df1_prep[df1_prep['Function'] == func]
        .sort_values(['Officer Title Group', 'Year YTD'])
    )
    blocks.append(
        df2_prep[df2_prep['Function'] == func]
        .sort_values('Year YTD')
    )

df3 = pd.concat(blocks, ignore_index=True)

# =====================================================
# STEP 4: Final columns
# =====================================================
df3 = df3.rename(columns={
    'term_terms': 'Term Date - YTD Terms Vol',
    'term_hc': 'Term Date - YTD HC Avg',
    'term_ann': 'Term Date - YTD Ann Attrition',
    'noti_terms': 'Notification - YTD Terms',
    'noti_hc': 'Notification - YTD HC Avg',
    'noti_ann': 'Notification - YTD Ann Attrition'
})

final_cols = [
    'Function',
    'Officer Title Group',
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Term Date - YTD Ann Attrition',
    'Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg',
    'Notification - YTD Ann Attrition',
    'Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Month',
    'Year YTD'
]

df3 = df3[final_cols]

# =====================================================
# Excel Column Indexes
# =====================================================
FUNC_COL = 0
OFF_COL  = 1
TERM_TERMS_COL = 2
TERM_HC_COL    = 3
TERM_ANN_COL   = 4
TERM_NON_COL   = 5
NOTI_TERMS_COL = 6
NOTI_HC_COL    = 7
NOTI_ANN_COL   = 8
NOTI_NON_COL   = 9

# =====================================================
# Excel Writer
# =====================================================
def write_sheet(writer, sheet_name, df):
    wb = writer.book
    ws = wb.add_worksheet(sheet_name)
    writer.sheets[sheet_name] = ws

    # Formats
    header_fmt = wb.add_format({'bold': True, 'border': 1, 'align': 'center'})
    cell_fmt   = wb.add_format({'border': 1, 'align': 'center'})
    bold_line  = wb.add_format({'top': 2})   # for separator row
    pct1 = wb.add_format({'border': 1, 'num_format': '0.0%', 'align': 'center'})
    pct2 = wb.add_format({'border': 1, 'num_format': '0.00%', 'align': 'center'})

    # Header
    for c, col in enumerate(df.columns):
        ws.write(0, c, col, header_fmt)
        ws.set_column(c, c, 22)

    rows = len(df)

    for i in range(1, rows + 1):
        curr = df.iloc[i-1]

        # Write normal cells
        for c in range(len(df.columns)):
            ws.write(i, c, "" if pd.isna(curr.iloc[c]) else curr.iloc[c], cell_fmt)

        # Non-annualized (1 decimal)
        ws.write_formula(
            i, TERM_NON_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1},0)',
            pct1
        )
        ws.write_formula(
            i, NOTI_NON_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1},0)',
            pct1
        )

        # Annualized (Markets only)
        if 'Function' in df.columns and curr['Function'] in ['Markets', 'Markets Excluding Ops']:
            ws.write_formula(
                i, TERM_ANN_COL,
                f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
                f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1}*{annualization_factor},0)',
                pct2
            )
            ws.write_formula(
                i, NOTI_ANN_COL,
                f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
                f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1}*{annualization_factor},0)',
                pct2
            )

        # ===== Officer group separator (BOLD LINE, NOT in Function column)
        if i < rows:
            curr_off = df.iloc[i-1]['Officer Title Group']
            next_off = df.iloc[i]['Officer Title Group']
            curr_func = df.iloc[i-1]['Function']
            next_func = df.iloc[i]['Function']

            if curr_func == next_func and curr_off != next_off:
                for c in range(OFF_COL, len(df.columns)):
                    ws.write_blank(i + 1, c, None, bold_line)

    ws.freeze_panes(1, 0)

# =====================================================
# WRITE FINAL EXCEL
# =====================================================
with pd.ExcelWriter(
    "FINAL_MARKETS_REPORT.xlsx",
    engine="xlsxwriter",
    engine_kwargs={"options": {"nan_inf_to_errors": True}}
) as writer:

    write_sheet(writer, "All Product", df3)

    # GOC Summary
    df4_clean = df4.replace([np.inf, -np.inf], "").fillna("")
    df4_clean.to_excel(writer, sheet_name="GOC_Summary", index=False)

    for func in df3['Function'].unique():
        write_sheet(writer, str(func)[:31], df3[df3['Function'] == func])

print("âœ… FINAL FILE GENERATED â€” EXACT FORMAT AS CONFIRMED")















has_function = 'Function' in df.columns
has_officer  = 'Officer Title Group' in df.columns

function_end = False
officer_end  = False

if has_function:
    function_end = (
        i == total_rows or
        next_row['Function'] != curr['Function']
    )

if has_officer and not function_end:
    officer_end = (
        i == total_rows or
        next_row['Officer Title Group'] != curr['Officer Title Group']
    )



nd keep this line unchanged:

row_fmt = thick if (function_end or officer_end) else thin






import pandas as pd
import numpy as np
import xlsxwriter
from datetime import datetime

# =====================================================
# Helper
# =====================================================
def safe_div(n, d):
    return np.where(d == 0, np.nan, n / d)

# =====================================================
# Reporting Month + Annualization
# =====================================================
today = datetime.today()
if today.month == 1:
    report_month = "Dec"
    month_num = 12
else:
    report_month = datetime(today.year, today.month - 1, 1).strftime("%b")
    month_num = today.month - 1

annualization_factor = 12 / month_num

# =====================================================
# STEP 1: Prepare df1 (Individual)
# =====================================================
df1_prep = df1.rename(columns={
    'Markets Products': 'Function',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

# Fix comma numbers
for c in ['term_hc', 'noti_hc']:
    df1_prep[c] = (
        df1_prep[c].astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df1_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['term_terms'], df1_prep['term_hc'])

df1_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['noti_terms'], df1_prep['noti_hc'])

df1_prep['Month'] = report_month

# =====================================================
# STEP 2: Prepare df2 (TOTAL)
# =====================================================
df2_prep = df2.rename(columns={
    'Total Markets Products': 'Officer Title Group',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

for c in ['term_hc', 'noti_hc']:
    df2_prep[c] = (
        df2_prep[c].astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df2_prep['Function'] = df2_prep['Officer Title Group'].str.replace(r'^Total\s+', '', regex=True)

df2_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['term_terms'], df2_prep['term_hc'])

df2_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['noti_terms'], df2_prep['noti_hc'])

df2_prep['Month'] = report_month

# =====================================================
# STEP 3: Build df3
# =====================================================
blocks = []

for func in sorted(df1_prep['Function'].unique()):
    blocks.append(
        df1_prep[df1_prep['Function'] == func]
        .sort_values(['Officer Title Group', 'Year YTD'])
    )
    blocks.append(
        df2_prep[df2_prep['Function'] == func]
        .sort_values('Year YTD')
    )

df3 = pd.concat(blocks, ignore_index=True)

# =====================================================
# STEP 4: Final Columns
# =====================================================
df3 = df3.rename(columns={
    'term_terms': 'Term Date - YTD Terms Vol',
    'term_hc': 'Term Date - YTD HC Avg',
    'term_ann': 'Term Date - YTD Ann Attrition',
    'noti_terms': 'Notification - YTD Terms',
    'noti_hc': 'Notification - YTD HC Avg',
    'noti_ann': 'Notification - YTD Ann Attrition'
})

final_cols = [
    'Function',
    'Officer Title Group',
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Term Date - YTD Ann Attrition',
    'Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg',
    'Notification - YTD Ann Attrition',
    'Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Month',
    'Year YTD'
]

df3 = df3[final_cols]

# =====================================================
# Excel Column Indexes
# =====================================================
TERM_TERMS_COL = 2
TERM_HC_COL    = 3
TERM_ANN_COL   = 4
TERM_NON_COL   = 5
NOTI_TERMS_COL = 6
NOTI_HC_COL    = 7
NOTI_ANN_COL   = 8
NOTI_NON_COL   = 9

# =====================================================
# Excel Writer
# =====================================================
output_file = "DEC_2025_MARKETS_FINAL.xlsx"

def write_sheet(writer, name, df):
    wb = writer.book
    ws = wb.add_worksheet(name)
    writer.sheets[name] = ws

    thin = wb.add_format({'border': 1, 'align': 'center', 'valign': 'vcenter'})
    thick = wb.add_format({'bottom': 2, 'align': 'center', 'valign': 'vcenter'})
    pct1 = wb.add_format({'border': 1, 'num_format': '0.0%', 'align': 'center'})
    pct2 = wb.add_format({'border': 1, 'num_format': '0.00%', 'align': 'center'})
    header = wb.add_format({'bold': True, 'border': 1, 'align': 'center'})

    # Header
    for c, col in enumerate(df.columns):
        ws.write(0, c, col, header)
        ws.set_column(c, c, 22)

    total_rows = len(df)

    for i in range(1, total_rows + 1):
        curr = df.iloc[i - 1]
        next_row = None if i == total_rows else df.iloc[i]

        function_end = (
            i == total_rows or
            next_row['Function'] != curr['Function']
        )

        officer_end = (
            not function_end and
            next_row['Officer Title Group'] != curr['Officer Title Group']
        )

        row_fmt = thick if (function_end or officer_end) else thin

        for c in range(len(df.columns)):
            val = curr.iloc[c]
            ws.write(i, c, "" if pd.isna(val) or val in [np.inf, -np.inf] else val, row_fmt)

        # Non-annualized (1 decimal)
        ws.write_formula(
            i, TERM_NON_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1},0)',
            pct1
        )

        ws.write_formula(
            i, NOTI_NON_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1},0)',
            pct1
        )

        # Annualized ONLY for Markets
        if curr['Function'] in ['Markets', 'Markets Excluding Ops']:
            ws.write_formula(
                i, TERM_ANN_COL,
                f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
                f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1}*{annualization_factor},0)',
                pct2
            )
            ws.write_formula(
                i, NOTI_ANN_COL,
                f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
                f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1}*{annualization_factor},0)',
                pct2
            )

    ws.freeze_panes(1, 0)

# =====================================================
# WRITE FILE
# =====================================================
with pd.ExcelWriter(
    output_file,
    engine="xlsxwriter",
    engine_kwargs={"options": {"nan_inf_to_errors": True}}
) as writer:

    write_sheet(writer, "All Product", df3)

    # GOC Summary
    df4_clean = df4.replace([np.inf, -np.inf], "").fillna("")
    df4_clean.to_excel(writer, sheet_name="GOC_Summary", index=False)

    for func in df3['Function'].unique():
        write_sheet(writer, str(func)[:31], df3[df3['Function'] == func])

print("âœ… FINAL REPORT GENERATED SUCCESSFULLY")

















import pandas as pd
import numpy as np
import xlsxwriter
from datetime import datetime

# =====================================================
# CONFIG
# =====================================================
counter = False   # ðŸ” Set True only if you want to inject extra rows

extra_rows_config = [
    # Example:
    # {
    #     "Function": "CMM",
    #     "Officer Title Group": "NON-OFF",
    #     "Year YTD": 2025,
    #     "Month": "Dec",
    #     "fill_values": {
    #         "Term Date - YTD Terms Vol": 0,
    #         "Term Date - YTD HC Avg": 0,
    #         "Notification - YTD Terms": 0,
    #         "Notification - YTD HC Avg": 0
    #     }
    # }
]

# =====================================================
# Helpers
# =====================================================
def safe_div(n, d):
    return np.where(d == 0, np.nan, n / d)

# =====================================================
# Last completed month
# =====================================================
today = datetime.today()
report_month = "Dec" if today.month == 1 else datetime(
    today.year, today.month - 1, 1
).strftime("%b")

month_to_num = {
    "Jan": 1, "Feb": 2, "Mar": 3, "Apr": 4,
    "May": 5, "Jun": 6, "Jul": 7, "Aug": 8,
    "Sep": 9, "Oct": 10, "Nov": 11, "Dec": 12
}
completed_month_num = month_to_num[report_month]
annualization_factor = f"(12/{completed_month_num})"

# =====================================================
# STEP 1: df1 (Individual)
# =====================================================
df1_prep = df1.rename(columns={
    'Markets Products': 'Function',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

for c in ['term_hc', 'noti_hc']:
    df1_prep[c] = (
        df1_prep[c].astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df1_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['term_terms'], df1_prep['term_hc'])

df1_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['noti_terms'], df1_prep['noti_hc'])

df1_prep['Month'] = report_month

# =====================================================
# STEP 2: df2 (TOTAL)
# =====================================================
df2_prep = df2.rename(columns={
    'Total Markets Products': 'Officer Title Group',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

for c in ['term_hc', 'noti_hc']:
    df2_prep[c] = (
        df2_prep[c].astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df2_prep['Function'] = df2_prep['Officer Title Group'].str.replace(
    r'^Total\s+', '', regex=True
)

df2_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['term_terms'], df2_prep['term_hc'])

df2_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['noti_terms'], df2_prep['noti_hc'])

df2_prep['Month'] = report_month

# =====================================================
# STEP 3: Build df3 base
# =====================================================
blocks = []
for f in sorted(df1_prep['Function'].unique()):
    blocks.append(
        df1_prep[df1_prep['Function'] == f]
        .sort_values(['Officer Title Group', 'Year YTD'])
    )
    blocks.append(
        df2_prep[df2_prep['Function'] == f]
        .sort_values('Year YTD')
    )

df3 = pd.concat(blocks, ignore_index=True)

# =====================================================
# STEP 4: Final column order
# =====================================================
df3 = df3.rename(columns={
    'term_terms': 'Term Date - YTD Terms Vol',
    'term_hc': 'Term Date - YTD HC Avg',
    'term_ann': 'Term Date - YTD Ann Attrition',
    'noti_terms': 'Notification - YTD Terms',
    'noti_hc': 'Notification - YTD HC Avg',
    'noti_ann': 'Notification - YTD Ann Attrition'
})

final_cols = [
    'Function',
    'Officer Title Group',
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Term Date - YTD Ann Attrition',
    'Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg',
    'Notification - YTD Ann Attrition',
    'Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Month',
    'Year YTD'
]
df3 = df3[final_cols]
df3['Year YTD'] = df3['Year YTD'].astype(int)

# =====================================================
# STEP 5: FAST extra-row injection (merge-based)
# =====================================================
if counter and extra_rows_config:
    inject = pd.DataFrame(extra_rows_config)
    rows = []

    for _, r in inject.iterrows():
        row = dict.fromkeys(df3.columns, "")
        row['Function'] = r['Function']
        row['Officer Title Group'] = r['Officer Title Group']
        row['Year YTD'] = int(r['Year YTD'])
        row['Month'] = r.get('Month', report_month)
        for k, v in r.get('fill_values', {}).items():
            row[k] = v
        rows.append(row)

    inject_df = pd.DataFrame(rows)

    merged = inject_df.merge(
        df3[['Function', 'Officer Title Group', 'Year YTD']],
        on=['Function', 'Officer Title Group', 'Year YTD'],
        how='left',
        indicator=True
    )

    missing = merged[merged['_merge'] == 'left_only'].drop(columns='_merge')
    df3 = pd.concat([df3, missing], ignore_index=True)

# =====================================================
# STEP 6: Markets & Markets Excluding Ops
# =====================================================
NUMERIC_COLS = [
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg'
]

is_total = df3['Officer Title Group'].str.startswith('Total', na=False)
officer_df = df3[~is_total]
total_df   = df3[is_total]

def align(df):
    for c in final_cols:
        if c not in df.columns:
            df[c] = ""
    return df[final_cols]

markets_officer = (
    officer_df.groupby(['Officer Title Group', 'Year YTD'], as_index=False)[NUMERIC_COLS]
    .sum(min_count=1)
)
markets_officer['Function'] = 'Markets'
markets_officer['Month'] = report_month

markets_total = (
    total_df.groupby(['Year YTD'], as_index=False)[NUMERIC_COLS]
    .sum(min_count=1)
)
markets_total['Function'] = 'Markets'
markets_total['Officer Title Group'] = 'Total Markets'
markets_total['Month'] = report_month

markets_ex_ops_officer = (
    officer_df[officer_df['Function'] != 'Ops']
    .groupby(['Officer Title Group', 'Year YTD'], as_index=False)[NUMERIC_COLS]
    .sum(min_count=1)
)
markets_ex_ops_officer['Function'] = 'Markets Excluding Ops'
markets_ex_ops_officer['Month'] = report_month

markets_ex_ops_total = (
    total_df[total_df['Function'] != 'Ops']
    .groupby(['Year YTD'], as_index=False)[NUMERIC_COLS]
    .sum(min_count=1)
)
markets_ex_ops_total['Function'] = 'Markets Excluding Ops'
markets_ex_ops_total['Officer Title Group'] = 'Total Markets Excluding Ops'
markets_ex_ops_total['Month'] = report_month

df3 = pd.concat([
    df3,
    align(markets_officer),
    align(markets_total),
    align(markets_ex_ops_officer),
    align(markets_ex_ops_total)
], ignore_index=True)

# =====================================================
# STEP 7: Excel writer with borders & formats
# =====================================================
TERM_TERMS_COL = 2
TERM_HC_COL = 3
TERM_ANN_COL = 4
TERM_NON_ANN_COL = 5
NOTI_TERMS_COL = 6
NOTI_HC_COL = 7
NOTI_ANN_COL = 8
NOTI_NON_ANN_COL = 9

def write_sheet(writer, name, df):
    wb = writer.book
    ws = wb.add_worksheet(name)
    writer.sheets[name] = ws

    df.to_excel(writer, sheet_name=name, index=False)

    thin = wb.add_format({'border': 1, 'align': 'center', 'valign': 'vcenter'})
    thick = wb.add_format({'bottom': 2, 'align': 'center', 'valign': 'vcenter'})
    pct1 = wb.add_format({'border': 1, 'align': 'center', 'valign': 'vcenter', 'num_format': '0.0%'})
    pct2 = wb.add_format({'border': 1, 'align': 'center', 'valign': 'vcenter', 'num_format': '0.00%'})

    rows, cols = df.shape

    for i in range(1, rows + 1):
        curr_func = df.iloc[i-1]['Function'] if 'Function' in df.columns else None
        curr_off  = df.iloc[i-1]['Officer Title Group'] if 'Officer Title Group' in df.columns else None

        if i == rows:
            use_thick = True
        else:
            next_func = df.iloc[i]['Function'] if 'Function' in df.columns else None
            next_off  = df.iloc[i]['Officer Title Group'] if 'Officer Title Group' in df.columns else None
            use_thick = (next_func != curr_func) or (next_off != curr_off)

        fmt = thick if use_thick else thin

        for c in range(cols):
            val = df.iloc[i-1, c]
            ws.write(i, c, "" if pd.isna(val) else val, fmt)

        ws.write_formula(
            i, TERM_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1},0)',
            pct1
        )

        ws.write_formula(
            i, NOTI_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1},0)',
            pct1
        )

        if 'Function' in df.columns and curr_func in ['Markets', 'Markets Excluding Ops']:
            ws.write_formula(
                i, TERM_ANN_COL,
                f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
                f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1}*{annualization_factor},0)',
                pct2
            )
            ws.write_formula(
                i, NOTI_ANN_COL,
                f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
                f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1}*{annualization_factor},0)',
                pct2
            )

    ws.freeze_panes(1, 0)

# =====================================================
# WRITE FINAL EXCEL
# =====================================================
with pd.ExcelWriter(
    "DEC_2025_MARKETS_FINAL.xlsx",
    engine="xlsxwriter",
    engine_kwargs={"options": {"nan_inf_to_errors": True}}
) as writer:

    write_sheet(writer, "All Product", df3)

    df4_clean = df4.replace([np.inf, -np.inf], "").fillna("")
    write_sheet(writer, "GOC_Summary", df4_clean)

    for f in df3['Function'].unique():
        write_sheet(writer, str(f)[:31], df3[df3['Function'] == f])

print("âœ… FINAL FILE GENERATED SUCCESSFULLY")







thin_border = wb.add_format({
    'border': 1,
    'align': 'center',
    'valign': 'vcenter'
})

thick_bottom = wb.add_format({
    'bottom': 2,
    'align': 'center',
    'valign': 'vcenter'
})

pct_2 = wb.add_format({
    'border': 1,
    'align': 'center',
    'valign': 'vcenter',
    'num_format': '0.00%'
})

pct_1 = wb.add_format({
    'border': 1,
    'align': 'center',
    'valign': 'vcenter',
    'num_format': '0.0%'
})





for i in range(1, r + 1):

    # Decide if thick border needed
    is_last_row = i == r
    next_func = None
    next_officer = None

    if not is_last_row and 'Function' in df.columns:
        next_func = df.iloc[i]['Function']
        next_officer = df.iloc[i]['Officer Title Group']

    curr_func = df.iloc[i-1]['Function'] if 'Function' in df.columns else None
    curr_officer = df.iloc[i-1]['Officer Title Group'] if 'Officer Title Group' in df.columns else None

    use_thick = (
        is_last_row or
        (next_func != curr_func) or
        (next_officer != curr_officer)
    )

    cell_fmt = thick_bottom if use_thick else thin_border

    # Write all cells with chosen border
    for c in range(c):
        val = df.iloc[i-1, c]
        ws.write(i, c, "" if pd.isna(val) else val, cell_fmt)

    # ============================
    # Non-annualized (1 decimal %)
    # ============================
    ws.write_formula(
        i, TERM_NON_ANN_COL,
        f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
        f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1},0)',
        pct_1
    )

    ws.write_formula(
        i, NOTI_NON_ANN_COL,
        f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
        f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1},0)',
        pct_1
    )

    # ============================
    # Annualized (Markets only)
    # ============================
    if 'Function' in df.columns and curr_func in ['Markets', 'Markets Excluding Ops']:
        ws.write_formula(
            i, TERM_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1}*{annualization_factor},0)',
            pct_2
        )

        ws.write_formula(
            i, NOTI_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1}*{annualization_factor},0)',
            pct_2
        )








month_to_num = {
    "Jan": 1, "Feb": 2, "Mar": 3, "Apr": 4,
    "May": 5, "Jun": 6, "Jul": 7, "Aug": 8,
    "Sep": 9, "Oct": 10, "Nov": 11, "Dec": 12
}



completed_month_num = month_to_num[report_month]
annualization_factor = f"(12/{completed_month_num})"



# Term Date - YTD Ann Attrition (Markets only)
ws.write_formula(
    i,
    TERM_ANN_COL,
    f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
    f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1}*{annualization_factor},0)',
    pct
)

# Notification - YTD Ann Attrition (Markets only)
ws.write_formula(
    i,
    NOTI_ANN_COL,
    f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
    f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1}*{annualization_factor},0)',
    pct
)









if 'Function' in df.columns and df.iloc[i-1]['Function'] in ['Markets', 'Markets Excluding Ops']:

for i in range(1, r + 1):

    # Non-annualized (ALL sheets)
    ws.write_formula(
        i, TERM_NON_ANN_COL,
        f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
        f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1},0)',
        pct
    )
    ws.write_formula(
        i, NOTI_NON_ANN_COL,
        f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
        f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1},0)',
        pct
    )

    # âœ… Annualized ONLY if Function column exists AND is Markets*
    if 'Function' in df.columns and df.iloc[i-1]['Function'] in ['Markets', 'Markets Excluding Ops']:

        ws.write_formula(
            i, TERM_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1}*(12/12),0)',
            pct
        )

        ws.write_formula(
            i, NOTI_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1}*(12/12),0)',
            pct
        )












import pandas as pd
import numpy as np
import xlsxwriter
from datetime import datetime

# =====================================================
# CONFIG: Optional extra-row injection
# =====================================================
counter = False   # âœ… set True only if you want to inject rows

extra_rows_config = [
    # Example:
    # {
    #     "Function": "CMM",
    #     "Officer Title Group": "NON-OFF",
    #     "Year YTD": 2025,
    #     "Month": "Dec",
    #     "fill_values": {
    #         "Term Date - YTD Terms Vol": 0,
    #         "Term Date - YTD HC Avg": 0,
    #         "Notification - YTD Terms": 0,
    #         "Notification - YTD HC Avg": 0
    #     }
    # }
]

# =====================================================
# Helpers
# =====================================================
def safe_div(n, d):
    return np.where(d == 0, np.nan, n / d)

# =====================================================
# Last completed month
# =====================================================
today = datetime.today()
report_month = "Dec" if today.month == 1 else datetime(
    today.year, today.month - 1, 1
).strftime("%b")

# =====================================================
# STEP 1: Prepare df1 (Individual)
# =====================================================
df1_prep = df1.rename(columns={
    'Markets Products': 'Function',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

for c in ['term_hc', 'noti_hc']:
    df1_prep[c] = (
        df1_prep[c].astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df1_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['term_terms'], df1_prep['term_hc'])

df1_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df1_prep['noti_terms'], df1_prep['noti_hc'])

df1_prep['Month'] = report_month

# =====================================================
# STEP 2: Prepare df2 (TOTAL)
# =====================================================
df2_prep = df2.rename(columns={
    'Total Markets Products': 'Officer Title Group',
    'Term Date - YTD Terms Vol': 'term_terms',
    'Term Date - YTD HC Avg': 'term_hc',
    'Term Date - YTD Ann Attrition': 'term_ann',
    'Notification - YTD Terms': 'noti_terms',
    'Notification - YTD HC Avg': 'noti_hc',
    'Notification - YTD Ann Attrition': 'noti_ann',
    'YTD Year': 'Year YTD'
})

for c in ['term_hc', 'noti_hc']:
    df2_prep[c] = (
        df2_prep[c].astype(str)
        .replace({',': ''}, regex=True)
        .apply(pd.to_numeric, errors='coerce')
    )

df2_prep['Function'] = df2_prep['Officer Title Group'].str.replace(
    r'^Total\s+', '', regex=True
)

df2_prep['Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['term_terms'], df2_prep['term_hc'])

df2_prep['Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)'] = \
    safe_div(df2_prep['noti_terms'], df2_prep['noti_hc'])

df2_prep['Month'] = report_month

# =====================================================
# STEP 3: Build base df3
# =====================================================
blocks = []

for f in sorted(df1_prep['Function'].unique()):
    blocks.append(
        df1_prep[df1_prep['Function'] == f]
        .sort_values(['Officer Title Group', 'Year YTD'])
    )
    blocks.append(
        df2_prep[df2_prep['Function'] == f]
        .sort_values('Year YTD')
    )

df3 = pd.concat(blocks, ignore_index=True)

# =====================================================
# STEP 4: Final column order
# =====================================================
df3 = df3.rename(columns={
    'term_terms': 'Term Date - YTD Terms Vol',
    'term_hc': 'Term Date - YTD HC Avg',
    'term_ann': 'Term Date - YTD Ann Attrition',
    'noti_terms': 'Notification - YTD Terms',
    'noti_hc': 'Notification - YTD HC Avg',
    'noti_ann': 'Notification - YTD Ann Attrition'
})

final_cols = [
    'Function',
    'Officer Title Group',
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Term Date - YTD Ann Attrition',
    'Termination - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg',
    'Notification - YTD Ann Attrition',
    'Notification - YTD Non-annualized Attrition (Attrition% of HC Avg)',
    'Month',
    'Year YTD'
]

df3 = df3[final_cols]
df3['Year YTD'] = df3['Year YTD'].astype(int)

# =====================================================
# STEP 5: FAST MERGE-BASED EXTRA ROW INGESTION
# =====================================================
if counter and extra_rows_config:
    extra_cfg_df = pd.DataFrame(extra_rows_config)

    base_rows = []
    for _, r in extra_cfg_df.iterrows():
        row = dict.fromkeys(df3.columns, "")
        row['Function'] = r['Function']
        row['Officer Title Group'] = r['Officer Title Group']
        row['Year YTD'] = int(r['Year YTD'])
        row['Month'] = r.get('Month', report_month)
        for k, v in r.get('fill_values', {}).items():
            row[k] = v
        base_rows.append(row)

    inject_df = pd.DataFrame(base_rows)

    merged = inject_df.merge(
        df3[['Function', 'Officer Title Group', 'Year YTD']],
        on=['Function', 'Officer Title Group', 'Year YTD'],
        how='left',
        indicator=True
    )

    missing = merged[merged['_merge'] == 'left_only'].drop(columns='_merge')

    if not missing.empty:
        df3 = pd.concat([df3, missing], ignore_index=True)

# =====================================================
# STEP 6: BUILD MARKETS & MARKETS EXCLUDING OPS (FULL BLOCKS)
# =====================================================
NUMERIC_COLS = [
    'Term Date - YTD Terms Vol',
    'Term Date - YTD HC Avg',
    'Notification - YTD Terms',
    'Notification - YTD HC Avg'
]

is_total = df3['Officer Title Group'].str.startswith('Total', na=False)
officer_df = df3[~is_total]
total_df   = df3[is_total]

def align_cols(df):
    for c in final_cols:
        if c not in df.columns:
            df[c] = ""
    return df[final_cols]

# Markets
markets_officer = (
    officer_df.groupby(['Officer Title Group', 'Year YTD'], as_index=False)[NUMERIC_COLS]
    .sum(min_count=1)
)
markets_officer['Function'] = 'Markets'
markets_officer['Month'] = report_month

markets_total = (
    total_df.groupby(['Year YTD'], as_index=False)[NUMERIC_COLS]
    .sum(min_count=1)
)
markets_total['Function'] = 'Markets'
markets_total['Officer Title Group'] = 'Total Markets'
markets_total['Month'] = report_month

# Markets Excluding Ops
markets_ex_ops_officer = (
    officer_df[officer_df['Function'] != 'Ops']
    .groupby(['Officer Title Group', 'Year YTD'], as_index=False)[NUMERIC_COLS]
    .sum(min_count=1)
)
markets_ex_ops_officer['Function'] = 'Markets Excluding Ops'
markets_ex_ops_officer['Month'] = report_month

markets_ex_ops_total = (
    total_df[total_df['Function'] != 'Ops']
    .groupby(['Year YTD'], as_index=False)[NUMERIC_COLS]
    .sum(min_count=1)
)
markets_ex_ops_total['Function'] = 'Markets Excluding Ops'
markets_ex_ops_total['Officer Title Group'] = 'Total Markets Excluding Ops'
markets_ex_ops_total['Month'] = report_month

df3 = pd.concat([
    df3,
    align_cols(markets_officer),
    align_cols(markets_total),
    align_cols(markets_ex_ops_officer),
    align_cols(markets_ex_ops_total)
], ignore_index=True)

# =====================================================
# STEP 7: EXCEL WRITING (FORMULAS + FORMAT)
# =====================================================
TERM_TERMS_COL = 2
TERM_HC_COL = 3
TERM_ANN_COL = 4
TERM_NON_ANN_COL = 5
NOTI_TERMS_COL = 6
NOTI_HC_COL = 7
NOTI_ANN_COL = 8
NOTI_NON_ANN_COL = 9

def write_sheet(writer, name, df):
    wb = writer.book
    ws = wb.add_worksheet(name)
    writer.sheets[name] = ws

    df.to_excel(writer, sheet_name=name, index=False)

    border = wb.add_format({'border': 1, 'align': 'center', 'valign': 'vcenter'})
    pct = wb.add_format({'border': 1, 'align': 'center', 'valign': 'vcenter', 'num_format': '0.00%'})

    r, c = df.shape
    ws.conditional_format(0, 0, r, c - 1, {'type': 'no_errors', 'format': border})

    for i in range(1, r + 1):

        # Non-annualized (ALL functions)
        ws.write_formula(
            i, TERM_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1},0)',
            pct
        )
        ws.write_formula(
            i, NOTI_NON_ANN_COL,
            f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
            f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1},0)',
            pct
        )

        # Annualized ONLY for Markets & Markets Excluding Ops
        if df.iloc[i-1]['Function'] in ['Markets', 'Markets Excluding Ops']:
            ws.write_formula(
                i, TERM_ANN_COL,
                f'=IFERROR({xlsxwriter.utility.xl_col_to_name(TERM_TERMS_COL)}{i+1}/'
                f'{xlsxwriter.utility.xl_col_to_name(TERM_HC_COL)}{i+1}*(12/12),0)',
                pct
            )
            ws.write_formula(
                i, NOTI_ANN_COL,
                f'=IFERROR({xlsxwriter.utility.xl_col_to_name(NOTI_TERMS_COL)}{i+1}/'
                f'{xlsxwriter.utility.xl_col_to_name(NOTI_HC_COL)}{i+1}*(12/12),0)',
                pct
            )

    ws.freeze_panes(1, 0)

# =====================================================
# WRITE FINAL EXCEL
# =====================================================
with pd.ExcelWriter(
    "DEC_2025_MARKETS_FINAL.xlsx",
    engine="xlsxwriter",
    engine_kwargs={"options": {"nan_inf_to_errors": True}}
) as writer:

    write_sheet(writer, "All Product", df3)

    df4_clean = df4.replace([np.inf, -np.inf], "").fillna("")
    write_sheet(writer, "GOC_Summary", df4_clean)

    for f in df3['Function'].unique():
        write_sheet(writer, str(f)[:31], df3[df3['Function'] == f])

print("âœ… FINAL FILE GENERATED â€” ALL REQUIREMENTS SATISFIED")
