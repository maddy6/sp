--------------------------------------------------------------------------------
-- LISTAGG diff-export: one row per composite-key that has any column difference
-- Filters: ETL_BATCHID = '20251124'
--------------------------------------------------------------------------------
WITH
-- 1) normalized MAIN
main_norm AS (
  SELECT
    TRIM(TO_CHAR(JOB_APPLICATION))     AS JOB_APPLICATION,
    TRIM(TO_CHAR(CANDIDATE_ID))        AS CANDIDATE_ID,
    TRIM(TO_CHAR(POSITION))            AS POSITION,
    TRIM(TO_CHAR(EMPLOYEE_ID))         AS EMPLOYEE_ID,
    TRIM(TO_CHAR(SOEID))               AS SOEID,
    TRIM(TO_CHAR(JOB_REQUISITION))     AS JOB_REQUISITION,
    TRIM(TO_CHAR(ADDED_DATE,'YYYY-MM-DD HH24:MI:SS')) AS ADDED_DATE,
    TRIM(TO_CHAR(ORIGINAL_JOB_REQUISITION)) AS ORIGINAL_JOB_REQUISITION,
    TRIM(TO_CHAR(SOURCE_CATEGORY))    AS SOURCE_CATEGORY,
    TRIM(TO_CHAR(SOURCE))             AS SOURCE,
    TRIM(TO_CHAR(RECRUITING_AGENCY))  AS RECRUITING_AGENCY,
    TRIM(TO_CHAR(CANDIDATE_STATUS))   AS CANDIDATE_STATUS,
    TRIM(TO_CHAR(LAST_RECRUITING_STAGE))  AS LAST_RECRUITING_STAGE,
    TRIM(TO_CHAR(JOB_APPLICATION_STEP))   AS JOB_APPLICATION_STEP,
    TRIM(TO_CHAR(LAST_RECRUITING_STAGE_NUMBER)) AS LAST_RECRUITING_STAGE_NUMBER,
    TRIM(TO_CHAR(FINAL_DISPOSITION_REASON))     AS FINAL_DISPOSITION_REASON,
    TRIM(TO_CHAR(OFFER_STATUS))       AS OFFER_STATUS,
    TRIM(TO_CHAR(HIRED))              AS HIRED,
    TRIM(TO_CHAR(TIME_TO_OFFER_ACCEPT_DAYS)) AS TIME_TO_OFFER_ACCEPT_DAYS,
    TRIM(TO_CHAR(TIME_TO_OFFER_REJECT_DAYS)) AS TIME_TO_OFFER_REJECT_DAYS,
    TRIM(TO_CHAR(CANDIDATE_START_DATE,'YYYY-MM-DD HH24:MI:SS')) AS CANDIDATE_START_DATE,
    TRIM(TO_CHAR(REFERRED_BY))        AS REFERRED_BY,
    TRIM(TO_CHAR(CREATED_DATE,'YYYY-MM-DD HH24:MI:SS')) AS CREATED_DATE,
    TRIM(TO_CHAR(DATE_TIME_COMPLETED,'YYYY-MM-DD HH24:MI:SS')) AS DATE_TIME_COMPLETED,
    TRIM(TO_CHAR(UPDATED_BY))         AS UPDATED_BY,
    TRIM(TO_CHAR(UPDATED_ON,'YYYY-MM-DD HH24:MI:SS')) AS UPDATED_ON,
    TRIM(TO_CHAR(RECRUITER))          AS RECRUITER,
    TRIM(TO_CHAR(CANDIDATE_TAGS))     AS CANDIDATE_TAGS,
    TRIM(TO_CHAR(CANDIDATE_POOL))     AS CANDIDATE_POOL,
    TRIM(TO_CHAR(ETL_BATCHID))        AS ETL_BATCHID
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),

-- 2) normalized TEMP
temp_norm AS (
  SELECT
    TRIM(TO_CHAR(JOB_APPLICATION))     AS JOB_APPLICATION,
    TRIM(TO_CHAR(CANDIDATE_ID))        AS CANDIDATE_ID,
    TRIM(TO_CHAR(POSITION))            AS POSITION,
    TRIM(TO_CHAR(EMPLOYEE_ID))         AS EMPLOYEE_ID,
    TRIM(TO_CHAR(SOEID))               AS SOEID,
    TRIM(TO_CHAR(JOB_REQUISITION))     AS JOB_REQUISITION,
    TRIM(TO_CHAR(ADDED_DATE,'YYYY-MM-DD HH24:MI:SS')) AS ADDED_DATE,
    TRIM(TO_CHAR(ORIGINAL_JOB_REQUISITION)) AS ORIGINAL_JOB_REQUISITION,
    TRIM(TO_CHAR(SOURCE_CATEGORY))    AS SOURCE_CATEGORY,
    TRIM(TO_CHAR(SOURCE))             AS SOURCE,
    TRIM(TO_CHAR(RECRUITING_AGENCY))  AS RECRUITING_AGENCY,
    TRIM(TO_CHAR(CANDIDATE_STATUS))   AS CANDIDATE_STATUS,
    TRIM(TO_CHAR(LAST_RECRUITING_STAGE))  AS LAST_RECRUITING_STAGE,
    TRIM(TO_CHAR(JOB_APPLICATION_STEP))   AS JOB_APPLICATION_STEP,
    TRIM(TO_CHAR(LAST_RECRUITING_STAGE_NUMBER)) AS LAST_RECRUITING_STAGE_NUMBER,
    TRIM(TO_CHAR(FINAL_DISPOSITION_REASON))     AS FINAL_DISPOSITION_REASON,
    TRIM(TO_CHAR(OFFER_STATUS))       AS OFFER_STATUS,
    TRIM(TO_CHAR(HIRED))              AS HIRED,
    TRIM(TO_CHAR(TIME_TO_OFFER_ACCEPT_DAYS)) AS TIME_TO_OFFER_ACCEPT_DAYS,
    TRIM(TO_CHAR(TIME_TO_OFFER_REJECT_DAYS)) AS TIME_TO_OFFER_REJECT_DAYS,
    TRIM(TO_CHAR(CANDIDATE_START_DATE,'YYYY-MM-DD HH24:MI:SS')) AS CANDIDATE_START_DATE,
    TRIM(TO_CHAR(REFERRED_BY))        AS REFERRED_BY,
    TRIM(TO_CHAR(CREATED_DATE,'YYYY-MM-DD HH24:MI:SS')) AS CREATED_DATE,
    TRIM(TO_CHAR(DATE_TIME_COMPLETED,'YYYY-MM-DD HH24:MI:SS')) AS DATE_TIME_COMPLETED,
    TRIM(TO_CHAR(UPDATED_BY))         AS UPDATED_BY,
    TRIM(TO_CHAR(UPDATED_ON,'YYYY-MM-DD HH24:MI:SS')) AS UPDATED_ON,
    TRIM(TO_CHAR(RECRUITER))          AS RECRUITER,
    TRIM(TO_CHAR(CANDIDATE_TAGS))     AS CANDIDATE_TAGS,
    TRIM(TO_CHAR(CANDIDATE_POOL))     AS CANDIDATE_POOL,
    TRIM(TO_CHAR(ETL_BATCHID))        AS ETL_BATCHID
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),

-- 3) join by composite key (one row per key match; if TEMP duplicates exist this will produce multiple rows for same MAIN key)
keyed_pairs AS (
  SELECT
    m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
    -- main side
    NVL(m.ORIGINAL_JOB_REQUISITION,'<NULL>')    AS MAIN_ORIGINAL_JOB_REQUISITION,
    NVL(m.SOURCE_CATEGORY,'<NULL>')             AS MAIN_SOURCE_CATEGORY,
    NVL(m.SOURCE,'<NULL>')                      AS MAIN_SOURCE,
    NVL(m.RECRUITING_AGENCY,'<NULL>')           AS MAIN_RECRUITING_AGENCY,
    NVL(m.CANDIDATE_STATUS,'<NULL>')            AS MAIN_CANDIDATE_STATUS,
    NVL(m.LAST_RECRUITING_STAGE,'<NULL>')       AS MAIN_LAST_RECRUITING_STAGE,
    NVL(m.JOB_APPLICATION_STEP,'<NULL>')        AS MAIN_JOB_APPLICATION_STEP,
    NVL(m.LAST_RECRUITING_STAGE_NUMBER,'<NULL>')AS MAIN_LAST_RECRUITING_STAGE_NUMBER,
    NVL(m.FINAL_DISPOSITION_REASON,'<NULL>')    AS MAIN_FINAL_DISPOSITION_REASON,
    NVL(m.OFFER_STATUS,'<NULL>')                AS MAIN_OFFER_STATUS,
    NVL(m.HIRED,'<NULL>')                       AS MAIN_HIRED,
    NVL(m.TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>')   AS MAIN_TIME_TO_OFFER_ACCEPT_DAYS,
    NVL(m.TIME_TO_OFFER_REJECT_DAYS,'<NULL>')   AS MAIN_TIME_TO_OFFER_REJECT_DAYS,
    NVL(m.CANDIDATE_START_DATE,'<NULL>')        AS MAIN_CANDIDATE_START_DATE,
    NVL(m.REFERRED_BY,'<NULL>')                 AS MAIN_REFERRED_BY,
    NVL(m.CREATED_DATE,'<NULL>')                AS MAIN_CREATED_DATE,
    NVL(m.DATE_TIME_COMPLETED,'<NULL>')         AS MAIN_DATE_TIME_COMPLETED,
    NVL(m.UPDATED_BY,'<NULL>')                  AS MAIN_UPDATED_BY,
    NVL(m.UPDATED_ON,'<NULL>')                  AS MAIN_UPDATED_ON,
    NVL(m.RECRUITER,'<NULL>')                   AS MAIN_RECRUITER,
    NVL(m.CANDIDATE_TAGS,'<NULL>')              AS MAIN_CANDIDATE_TAGS,
    NVL(m.CANDIDATE_POOL,'<NULL>')              AS MAIN_CANDIDATE_POOL,
    NVL(m.ETL_BATCHID,'<NULL>')                 AS MAIN_ETL_BATCHID,
    -- temp side
    NVL(t.ORIGINAL_JOB_REQUISITION,'<NULL>')    AS TEMP_ORIGINAL_JOB_REQUISITION,
    NVL(t.SOURCE_CATEGORY,'<NULL>')             AS TEMP_SOURCE_CATEGORY,
    NVL(t.SOURCE,'<NULL>')                      AS TEMP_SOURCE,
    NVL(t.RECRUITING_AGENCY,'<NULL>')           AS TEMP_RECRUITING_AGENCY,
    NVL(t.CANDIDATE_STATUS,'<NULL>')            AS TEMP_CANDIDATE_STATUS,
    NVL(t.LAST_RECRUITING_STAGE,'<NULL>')       AS TEMP_LAST_RECRUITING_STAGE,
    NVL(t.JOB_APPLICATION_STEP,'<NULL>')        AS TEMP_JOB_APPLICATION_STEP,
    NVL(t.LAST_RECRUITING_STAGE_NUMBER,'<NULL>')AS TEMP_LAST_RECRUITING_STAGE_NUMBER,
    NVL(t.FINAL_DISPOSITION_REASON,'<NULL>')    AS TEMP_FINAL_DISPOSITION_REASON,
    NVL(t.OFFER_STATUS,'<NULL>')                AS TEMP_OFFER_STATUS,
    NVL(t.HIRED,'<NULL>')                       AS TEMP_HIRED,
    NVL(t.TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>')   AS TEMP_TIME_TO_OFFER_ACCEPT_DAYS,
    NVL(t.TIME_TO_OFFER_REJECT_DAYS,'<NULL>')   AS TEMP_TIME_TO_OFFER_REJECT_DAYS,
    NVL(t.CANDIDATE_START_DATE,'<NULL>')        AS TEMP_CANDIDATE_START_DATE,
    NVL(t.REFERRED_BY,'<NULL>')                 AS TEMP_REFERRED_BY,
    NVL(t.CREATED_DATE,'<NULL>')                AS TEMP_CREATED_DATE,
    NVL(t.DATE_TIME_COMPLETED,'<NULL>')         AS TEMP_DATE_TIME_COMPLETED,
    NVL(t.UPDATED_BY,'<NULL>')                  AS TEMP_UPDATED_BY,
    NVL(t.UPDATED_ON,'<NULL>')                  AS TEMP_UPDATED_ON,
    NVL(t.RECRUITER,'<NULL>')                   AS TEMP_RECRUITER,
    NVL(t.CANDIDATE_TAGS,'<NULL>')              AS TEMP_CANDIDATE_TAGS,
    NVL(t.CANDIDATE_POOL,'<NULL>')              AS TEMP_CANDIDATE_POOL,
    NVL(t.ETL_BATCHID,'<NULL>')                 AS TEMP_ETL_BATCHID
  FROM main_norm m
  JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
),

-- 4) produce one row per differing column per key
per_col_diffs AS (
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'ORIGINAL_JOB_REQUISITION' AS col_name, MAIN_ORIGINAL_JOB_REQUISITION AS main_val, TEMP_ORIGINAL_JOB_REQUISITION AS temp_val
  FROM keyed_pairs WHERE MAIN_ORIGINAL_JOB_REQUISITION <> TEMP_ORIGINAL_JOB_REQUISITION

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'SOURCE_CATEGORY', MAIN_SOURCE_CATEGORY, TEMP_SOURCE_CATEGORY FROM keyed_pairs WHERE MAIN_SOURCE_CATEGORY <> TEMP_SOURCE_CATEGORY

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'SOURCE', MAIN_SOURCE, TEMP_SOURCE FROM keyed_pairs WHERE MAIN_SOURCE <> TEMP_SOURCE

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'RECRUITING_AGENCY', MAIN_RECRUITING_AGENCY, TEMP_RECRUITING_AGENCY FROM keyed_pairs WHERE MAIN_RECRUITING_AGENCY <> TEMP_RECRUITING_AGENCY

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CANDIDATE_STATUS', MAIN_CANDIDATE_STATUS, TEMP_CANDIDATE_STATUS FROM keyed_pairs WHERE MAIN_CANDIDATE_STATUS <> TEMP_CANDIDATE_STATUS

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'LAST_RECRUITING_STAGE', MAIN_LAST_RECRUITING_STAGE, TEMP_LAST_RECRUITING_STAGE FROM keyed_pairs WHERE MAIN_LAST_RECRUITING_STAGE <> TEMP_LAST_RECRUITING_STAGE

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'JOB_APPLICATION_STEP', MAIN_JOB_APPLICATION_STEP, TEMP_JOB_APPLICATION_STEP FROM keyed_pairs WHERE MAIN_JOB_APPLICATION_STEP <> TEMP_JOB_APPLICATION_STEP

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'LAST_RECRUITING_STAGE_NUMBER', MAIN_LAST_RECRUITING_STAGE_NUMBER, TEMP_LAST_RECRUITING_STAGE_NUMBER FROM keyed_pairs WHERE MAIN_LAST_RECRUITING_STAGE_NUMBER <> TEMP_LAST_RECRUITING_STAGE_NUMBER

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'FINAL_DISPOSITION_REASON', MAIN_FINAL_DISPOSITION_REASON, TEMP_FINAL_DISPOSITION_REASON FROM keyed_pairs WHERE MAIN_FINAL_DISPOSITION_REASON <> TEMP_FINAL_DISPOSITION_REASON

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'OFFER_STATUS', MAIN_OFFER_STATUS, TEMP_OFFER_STATUS FROM keyed_pairs WHERE MAIN_OFFER_STATUS <> TEMP_OFFER_STATUS

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'HIRED', MAIN_HIRED, TEMP_HIRED FROM keyed_pairs WHERE MAIN_HIRED <> TEMP_HIRED

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'TIME_TO_OFFER_ACCEPT_DAYS', MAIN_TIME_TO_OFFER_ACCEPT_DAYS, TEMP_TIME_TO_OFFER_ACCEPT_DAYS FROM keyed_pairs WHERE MAIN_TIME_TO_OFFER_ACCEPT_DAYS <> TEMP_TIME_TO_OFFER_ACCEPT_DAYS

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'TIME_TO_OFFER_REJECT_DAYS', MAIN_TIME_TO_OFFER_REJECT_DAYS, TEMP_TIME_TO_OFFER_REJECT_DAYS FROM keyed_pairs WHERE MAIN_TIME_TO_OFFER_REJECT_DAYS <> TEMP_TIME_TO_OFFER_REJECT_DAYS

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CANDIDATE_START_DATE', MAIN_CANDIDATE_START_DATE, TEMP_CANDIDATE_START_DATE FROM keyed_pairs WHERE MAIN_CANDIDATE_START_DATE <> TEMP_CANDIDATE_START_DATE

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'REFERRED_BY', MAIN_REFERRED_BY, TEMP_REFERRED_BY FROM keyed_pairs WHERE MAIN_REFERRED_BY <> TEMP_REFERRED_BY

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CREATED_DATE', MAIN_CREATED_DATE, TEMP_CREATED_DATE FROM keyed_pairs WHERE MAIN_CREATED_DATE <> TEMP_CREATED_DATE

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'DATE_TIME_COMPLETED', MAIN_DATE_TIME_COMPLETED, TEMP_DATE_TIME_COMPLETED FROM keyed_pairs WHERE MAIN_DATE_TIME_COMPLETED <> TEMP_DATE_TIME_COMPLETED

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'UPDATED_BY', MAIN_UPDATED_BY, TEMP_UPDATED_BY FROM keyed_pairs WHERE MAIN_UPDATED_BY <> TEMP_UPDATED_BY

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'UPDATED_ON', MAIN_UPDATED_ON, TEMP_UPDATED_ON FROM keyed_pairs WHERE MAIN_UPDATED_ON <> TEMP_UPDATED_ON

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'RECRUITER', MAIN_RECRUITER, TEMP_RECRUITER FROM keyed_pairs WHERE MAIN_RECRUITER <> TEMP_RECRUITER

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CANDIDATE_TAGS', MAIN_CANDIDATE_TAGS, TEMP_CANDIDATE_TAGS FROM keyed_pairs WHERE MAIN_CANDIDATE_TAGS <> TEMP_CANDIDATE_TAGS

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CANDIDATE_POOL', MAIN_CANDIDATE_POOL, TEMP_CANDIDATE_POOL FROM keyed_pairs WHERE MAIN_CANDIDATE_POOL <> TEMP_CANDIDATE_POOL

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'ETL_BATCHID', MAIN_ETL_BATCHID, TEMP_ETL_BATCHID FROM keyed_pairs WHERE MAIN_ETL_BATCHID <> TEMP_ETL_BATCHID
)

-- 5) final aggregation: one row per key with LISTAGG of differing columns and values
SELECT
  JOB_APPLICATION,
  CANDIDATE_ID,
  POSITION,
  EMPLOYEE_ID,
  SOEID,
  JOB_REQUISITION,
  ADDED_DATE,
  COUNT(*) AS diff_count,
  LISTAGG(col_name, ', ') WITHIN GROUP (ORDER BY col_name) AS differing_columns,
  -- main side values like: "COL1=val; COL2=val; ..."
  LISTAGG(col_name || '=' || main_val, ' ; ') WITHIN GROUP (ORDER BY col_name) AS main_mismatch_vals,
  LISTAGG(col_name || '=' || temp_val, ' ; ') WITHIN GROUP (ORDER BY col_name) AS temp_mismatch_vals
FROM per_col_diffs
GROUP BY JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE
ORDER BY diff_count DESC, JOB_APPLICATION, CANDIDATE_ID;













---------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------

Matching Records ----------------------------------------------------------------------------------


--------------------------------------------------------------------------------
-- MATCHING-COLUMNS LISTAGG EXPORT (one row per composite key)
-- Shows which columns matched (and their values from MAIN and TEMP)
-- Filter: ETL_BATCHID = '20251124'
--------------------------------------------------------------------------------
WITH
-- 1) normalize MAIN (dates as CHAR strings)
main_norm AS (
  SELECT
    TRIM(TO_CHAR(JOB_APPLICATION))     AS JOB_APPLICATION,
    TRIM(TO_CHAR(CANDIDATE_ID))        AS CANDIDATE_ID,
    TRIM(TO_CHAR(POSITION))            AS POSITION,
    TRIM(TO_CHAR(EMPLOYEE_ID))         AS EMPLOYEE_ID,
    TRIM(TO_CHAR(SOEID))               AS SOEID,
    TRIM(TO_CHAR(JOB_REQUISITION))     AS JOB_REQUISITION,
    TRIM(TO_CHAR(ADDED_DATE))          AS ADDED_DATE,
    NVL(TRIM(TO_CHAR(ORIGINAL_JOB_REQUISITION)),'<NULL>') AS ORIGINAL_JOB_REQUISITION,
    NVL(TRIM(TO_CHAR(SOURCE_CATEGORY)),'<NULL>')          AS SOURCE_CATEGORY,
    NVL(TRIM(TO_CHAR(SOURCE)),'<NULL>')                   AS SOURCE,
    NVL(TRIM(TO_CHAR(RECRUITING_AGENCY)),'<NULL>')        AS RECRUITING_AGENCY,
    NVL(TRIM(TO_CHAR(CANDIDATE_STATUS)),'<NULL>')         AS CANDIDATE_STATUS,
    NVL(TRIM(TO_CHAR(LAST_RECRUITING_STAGE)),'<NULL>')    AS LAST_RECRUITING_STAGE,
    NVL(TRIM(TO_CHAR(JOB_APPLICATION_STEP)),'<NULL>')     AS JOB_APPLICATION_STEP,
    NVL(TRIM(TO_CHAR(LAST_RECRUITING_STAGE_NUMBER)),'<NULL>') AS LAST_RECRUITING_STAGE_NUMBER,
    NVL(TRIM(TO_CHAR(FINAL_DISPOSITION_REASON)),'<NULL>') AS FINAL_DISPOSITION_REASON,
    NVL(TRIM(TO_CHAR(OFFER_STATUS)),'<NULL>')             AS OFFER_STATUS,
    NVL(TRIM(TO_CHAR(HIRED)),'<NULL>')                    AS HIRED,
    NVL(TRIM(TO_CHAR(TIME_TO_OFFER_ACCEPT_DAYS)),'<NULL>') AS TIME_TO_OFFER_ACCEPT_DAYS,
    NVL(TRIM(TO_CHAR(TIME_TO_OFFER_REJECT_DAYS)),'<NULL>') AS TIME_TO_OFFER_REJECT_DAYS,
    NVL(TRIM(TO_CHAR(CANDIDATE_START_DATE)),'<NULL>')     AS CANDIDATE_START_DATE,
    NVL(TRIM(TO_CHAR(REFERRED_BY)),'<NULL>')              AS REFERRED_BY,
    NVL(TRIM(TO_CHAR(CREATED_DATE)),'<NULL>')             AS CREATED_DATE,
    NVL(TRIM(TO_CHAR(DATE_TIME_COMPLETED)),'<NULL>')      AS DATE_TIME_COMPLETED,
    NVL(TRIM(TO_CHAR(UPDATED_BY)),'<NULL>')               AS UPDATED_BY,
    NVL(TRIM(TO_CHAR(UPDATED_ON)),'<NULL>')               AS UPDATED_ON,
    NVL(TRIM(TO_CHAR(RECRUITER)),'<NULL>')                AS RECRUITER,
    NVL(TRIM(TO_CHAR(CANDIDATE_TAGS)),'<NULL>')           AS CANDIDATE_TAGS,
    NVL(TRIM(TO_CHAR(CANDIDATE_POOL)),'<NULL>')           AS CANDIDATE_POOL,
    NVL(TRIM(TO_CHAR(ETL_BATCHID)),'<NULL>')              AS ETL_BATCHID
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),

-- 2) normalize TEMP (dates as CHAR strings)
temp_norm AS (
  SELECT
    TRIM(TO_CHAR(JOB_APPLICATION))     AS JOB_APPLICATION,
    TRIM(TO_CHAR(CANDIDATE_ID))        AS CANDIDATE_ID,
    TRIM(TO_CHAR(POSITION))            AS POSITION,
    TRIM(TO_CHAR(EMPLOYEE_ID))         AS EMPLOYEE_ID,
    TRIM(TO_CHAR(SOEID))               AS SOEID,
    TRIM(TO_CHAR(JOB_REQUISITION))     AS JOB_REQUISITION,
    TRIM(TO_CHAR(ADDED_DATE))          AS ADDED_DATE,
    NVL(TRIM(TO_CHAR(ORIGINAL_JOB_REQUISITION)),'<NULL>') AS ORIGINAL_JOB_REQUISITION,
    NVL(TRIM(TO_CHAR(SOURCE_CATEGORY)),'<NULL>')          AS SOURCE_CATEGORY,
    NVL(TRIM(TO_CHAR(SOURCE)),'<NULL>')                   AS SOURCE,
    NVL(TRIM(TO_CHAR(RECRUITING_AGENCY)),'<NULL>')        AS RECRUITING_AGENCY,
    NVL(TRIM(TO_CHAR(CANDIDATE_STATUS)),'<NULL>')         AS CANDIDATE_STATUS,
    NVL(TRIM(TO_CHAR(LAST_RECRUITING_STAGE)),'<NULL>')    AS LAST_RECRUITING_STAGE,
    NVL(TRIM(TO_CHAR(JOB_APPLICATION_STEP)),'<NULL>')     AS JOB_APPLICATION_STEP,
    NVL(TRIM(TO_CHAR(LAST_RECRUITING_STAGE_NUMBER)),'<NULL>') AS LAST_RECRUITING_STAGE_NUMBER,
    NVL(TRIM(TO_CHAR(FINAL_DISPOSITION_REASON)),'<NULL>') AS FINAL_DISPOSITION_REASON,
    NVL(TRIM(TO_CHAR(OFFER_STATUS)),'<NULL>')             AS OFFER_STATUS,
    NVL(TRIM(TO_CHAR(HIRED)),'<NULL>')                    AS HIRED,
    NVL(TRIM(TO_CHAR(TIME_TO_OFFER_ACCEPT_DAYS)),'<NULL>') AS TIME_TO_OFFER_ACCEPT_DAYS,
    NVL(TRIM(TO_CHAR(TIME_TO_OFFER_REJECT_DAYS)),'<NULL>') AS TIME_TO_OFFER_REJECT_DAYS,
    NVL(TRIM(TO_CHAR(CANDIDATE_START_DATE)),'<NULL>')     AS CANDIDATE_START_DATE,
    NVL(TRIM(TO_CHAR(REFERRED_BY)),'<NULL>')              AS REFERRED_BY,
    NVL(TRIM(TO_CHAR(CREATED_DATE)),'<NULL>')             AS CREATED_DATE,
    NVL(TRIM(TO_CHAR(DATE_TIME_COMPLETED)),'<NULL>')      AS DATE_TIME_COMPLETED,
    NVL(TRIM(TO_CHAR(UPDATED_BY)),'<NULL>')               AS UPDATED_BY,
    NVL(TRIM(TO_CHAR(UPDATED_ON)),'<NULL>')               AS UPDATED_ON,
    NVL(TRIM(TO_CHAR(RECRUITER)),'<NULL>')                AS RECRUITER,
    NVL(TRIM(TO_CHAR(CANDIDATE_TAGS)),'<NULL>')           AS CANDIDATE_TAGS,
    NVL(TRIM(TO_CHAR(CANDIDATE_POOL)),'<NULL>')           AS CANDIDATE_POOL,
    NVL(TRIM(TO_CHAR(ETL_BATCHID)),'<NULL>')              AS ETL_BATCHID
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),

-- 3) keyed_pairs: MAIN join TEMP on composite key
keyed_pairs AS (
  SELECT
    m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
    -- MAIN side
    m.ORIGINAL_JOB_REQUISITION   AS MAIN_ORIGINAL_JOB_REQUISITION,
    m.SOURCE_CATEGORY            AS MAIN_SOURCE_CATEGORY,
    m.SOURCE                     AS MAIN_SOURCE,
    m.RECRUITING_AGENCY          AS MAIN_RECRUITING_AGENCY,
    m.CANDIDATE_STATUS           AS MAIN_CANDIDATE_STATUS,
    m.LAST_RECRUITING_STAGE      AS MAIN_LAST_RECRUITING_STAGE,
    m.JOB_APPLICATION_STEP       AS MAIN_JOB_APPLICATION_STEP,
    m.LAST_RECRUITING_STAGE_NUMBER AS MAIN_LAST_RECRUITING_STAGE_NUMBER,
    m.FINAL_DISPOSITION_REASON   AS MAIN_FINAL_DISPOSITION_REASON,
    m.OFFER_STATUS               AS MAIN_OFFER_STATUS,
    m.HIRED                      AS MAIN_HIRED,
    m.TIME_TO_OFFER_ACCEPT_DAYS  AS MAIN_TIME_TO_OFFER_ACCEPT_DAYS,
    m.TIME_TO_OFFER_REJECT_DAYS  AS MAIN_TIME_TO_OFFER_REJECT_DAYS,
    m.CANDIDATE_START_DATE       AS MAIN_CANDIDATE_START_DATE,
    m.REFERRED_BY                AS MAIN_REFERRED_BY,
    m.CREATED_DATE               AS MAIN_CREATED_DATE,
    m.DATE_TIME_COMPLETED        AS MAIN_DATE_TIME_COMPLETED,
    m.UPDATED_BY                 AS MAIN_UPDATED_BY,
    m.UPDATED_ON                 AS MAIN_UPDATED_ON,
    m.RECRUITER                  AS MAIN_RECRUITER,
    m.CANDIDATE_TAGS             AS MAIN_CANDIDATE_TAGS,
    m.CANDIDATE_POOL             AS MAIN_CANDIDATE_POOL,
    m.ETL_BATCHID                AS MAIN_ETL_BATCHID,
    -- TEMP side
    t.ORIGINAL_JOB_REQUISITION   AS TEMP_ORIGINAL_JOB_REQUISITION,
    t.SOURCE_CATEGORY            AS TEMP_SOURCE_CATEGORY,
    t.SOURCE                     AS TEMP_SOURCE,
    t.RECRUITING_AGENCY          AS TEMP_RECRUITING_AGENCY,
    t.CANDIDATE_STATUS           AS TEMP_CANDIDATE_STATUS,
    t.LAST_RECRUITING_STAGE      AS TEMP_LAST_RECRUITING_STAGE,
    t.JOB_APPLICATION_STEP       AS TEMP_JOB_APPLICATION_STEP,
    t.LAST_RECRUITING_STAGE_NUMBER AS TEMP_LAST_RECRUITING_STAGE_NUMBER,
    t.FINAL_DISPOSITION_REASON   AS TEMP_FINAL_DISPOSITION_REASON,
    t.OFFER_STATUS               AS TEMP_OFFER_STATUS,
    t.HIRED                      AS TEMP_HIRED,
    t.TIME_TO_OFFER_ACCEPT_DAYS  AS TEMP_TIME_TO_OFFER_ACCEPT_DAYS,
    t.TIME_TO_OFFER_REJECT_DAYS  AS TEMP_TIME_TO_OFFER_REJECT_DAYS,
    t.CANDIDATE_START_DATE       AS TEMP_CANDIDATE_START_DATE,
    t.REFERRED_BY                AS TEMP_REFERRED_BY,
    t.CREATED_DATE               AS TEMP_CREATED_DATE,
    t.DATE_TIME_COMPLETED        AS TEMP_DATE_TIME_COMPLETED,
    t.UPDATED_BY                 AS TEMP_UPDATED_BY,
    t.UPDATED_ON                 AS TEMP_UPDATED_ON,
    t.RECRUITER                  AS TEMP_RECRUITER,
    t.CANDIDATE_TAGS             AS TEMP_CANDIDATE_TAGS,
    t.CANDIDATE_POOL             AS TEMP_CANDIDATE_POOL,
    t.ETL_BATCHID                AS TEMP_ETL_BATCHID
  FROM main_norm m
  JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
),

-- 4) per-column matches: one row per matching column per key
per_col_matches AS (
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'ORIGINAL_JOB_REQUISITION' AS col_name,
         NVL(MAIN_ORIGINAL_JOB_REQUISITION,'<NULL>') AS main_val,
         NVL(TEMP_ORIGINAL_JOB_REQUISITION,'<NULL>') AS temp_val
  FROM keyed_pairs WHERE NVL(MAIN_ORIGINAL_JOB_REQUISITION,'<NULL>') = NVL(TEMP_ORIGINAL_JOB_REQUISITION,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'SOURCE_CATEGORY', NVL(MAIN_SOURCE_CATEGORY,'<NULL>'), NVL(TEMP_SOURCE_CATEGORY,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_SOURCE_CATEGORY,'<NULL>') = NVL(TEMP_SOURCE_CATEGORY,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'SOURCE', NVL(MAIN_SOURCE,'<NULL>'), NVL(TEMP_SOURCE,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_SOURCE,'<NULL>') = NVL(TEMP_SOURCE,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'RECRUITING_AGENCY', NVL(MAIN_RECRUITING_AGENCY,'<NULL>'), NVL(TEMP_RECRUITING_AGENCY,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_RECRUITING_AGENCY,'<NULL>') = NVL(TEMP_RECRUITING_AGENCY,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CANDIDATE_STATUS', NVL(MAIN_CANDIDATE_STATUS,'<NULL>'), NVL(TEMP_CANDIDATE_STATUS,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_CANDIDATE_STATUS,'<NULL>') = NVL(TEMP_CANDIDATE_STATUS,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'LAST_RECRUITING_STAGE', NVL(MAIN_LAST_RECRUITING_STAGE,'<NULL>'), NVL(TEMP_LAST_RECRUITING_STAGE,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_LAST_RECRUITING_STAGE,'<NULL>') = NVL(TEMP_LAST_RECRUITING_STAGE,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'JOB_APPLICATION_STEP', NVL(MAIN_JOB_APPLICATION_STEP,'<NULL>'), NVL(TEMP_JOB_APPLICATION_STEP,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_JOB_APPLICATION_STEP,'<NULL>') = NVL(TEMP_JOB_APPLICATION_STEP,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'LAST_RECRUITING_STAGE_NUMBER', NVL(MAIN_LAST_RECRUITING_STAGE_NUMBER,'<NULL>'), NVL(TEMP_LAST_RECRUITING_STAGE_NUMBER,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_LAST_RECRUITING_STAGE_NUMBER,'<NULL>') = NVL(TEMP_LAST_RECRUITING_STAGE_NUMBER,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'FINAL_DISPOSITION_REASON', NVL(MAIN_FINAL_DISPOSITION_REASON,'<NULL>'), NVL(TEMP_FINAL_DISPOSITION_REASON,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_FINAL_DISPOSITION_REASON,'<NULL>') = NVL(TEMP_FINAL_DISPOSITION_REASON,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'OFFER_STATUS', NVL(MAIN_OFFER_STATUS,'<NULL>'), NVL(TEMP_OFFER_STATUS,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_OFFER_STATUS,'<NULL>') = NVL(TEMP_OFFER_STATUS,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'HIRED', NVL(MAIN_HIRED,'<NULL>'), NVL(TEMP_HIRED,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_HIRED,'<NULL>') = NVL(TEMP_HIRED,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'TIME_TO_OFFER_ACCEPT_DAYS', NVL(MAIN_TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>'), NVL(TEMP_TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>') = NVL(TEMP_TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'TIME_TO_OFFER_REJECT_DAYS', NVL(MAIN_TIME_TO_OFFER_REJECT_DAYS,'<NULL>'), NVL(TEMP_TIME_TO_OFFER_REJECT_DAYS,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_TIME_TO_OFFER_REJECT_DAYS,'<NULL>') = NVL(TEMP_TIME_TO_OFFER_REJECT_DAYS,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CANDIDATE_START_DATE', NVL(MAIN_CANDIDATE_START_DATE,'<NULL>'), NVL(TEMP_CANDIDATE_START_DATE,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_CANDIDATE_START_DATE,'<NULL>') = NVL(TEMP_CANDIDATE_START_DATE,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'REFERRED_BY', NVL(MAIN_REFERRED_BY,'<NULL>'), NVL(TEMP_REFERRED_BY,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_REFERRED_BY,'<NULL>') = NVL(TEMP_REFERRED_BY,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CREATED_DATE', NVL(MAIN_CREATED_DATE,'<NULL>'), NVL(TEMP_CREATED_DATE,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_CREATED_DATE,'<NULL>') = NVL(TEMP_CREATED_DATE,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'DATE_TIME_COMPLETED', NVL(MAIN_DATE_TIME_COMPLETED,'<NULL>'), NVL(TEMP_DATE_TIME_COMPLETED,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_DATE_TIME_COMPLETED,'<NULL>') = NVL(TEMP_DATE_TIME_COMPLETED,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'UPDATED_BY', NVL(MAIN_UPDATED_BY,'<NULL>'), NVL(TEMP_UPDATED_BY,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_UPDATED_BY,'<NULL>') = NVL(TEMP_UPDATED_BY,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'UPDATED_ON', NVL(MAIN_UPDATED_ON,'<NULL>'), NVL(TEMP_UPDATED_ON,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_UPDATED_ON,'<NULL>') = NVL(TEMP_UPDATED_ON,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'RECRUITER', NVL(MAIN_RECRUITER,'<NULL>'), NVL(TEMP_RECRUITER,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_RECRUITER,'<NULL>') = NVL(TEMP_RECRUITER,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CANDIDATE_TAGS', NVL(MAIN_CANDIDATE_TAGS,'<NULL>'), NVL(TEMP_CANDIDATE_TAGS,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_CANDIDATE_TAGS,'<NULL>') = NVL(TEMP_CANDIDATE_TAGS,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'CANDIDATE_POOL', NVL(MAIN_CANDIDATE_POOL,'<NULL>'), NVL(TEMP_CANDIDATE_POOL,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_CANDIDATE_POOL,'<NULL>') = NVL(TEMP_CANDIDATE_POOL,'<NULL>')

  UNION ALL
  SELECT JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
         'ETL_BATCHID', NVL(MAIN_ETL_BATCHID,'<NULL>'), NVL(TEMP_ETL_BATCHID,'<NULL>') FROM keyed_pairs WHERE NVL(MAIN_ETL_BATCHID,'<NULL>') = NVL(TEMP_ETL_BATCHID,'<NULL>')
)

-- 5) aggregate: one row per key with matching columns and side-by-side values
SELECT
  p.JOB_APPLICATION,
  p.CANDIDATE_ID,
  p.POSITION,
  p.EMPLOYEE_ID,
  p.SOEID,
  p.JOB_REQUISITION,
  p.ADDED_DATE,
  COUNT(*) AS match_count,
  LISTAGG(col_name, ', ') WITHIN GROUP (ORDER BY col_name) AS matching_columns,
  LISTAGG(col_name || '=' || main_val, ' ; ') WITHIN GROUP (ORDER BY col_name) AS main_matched_vals,
  LISTAGG(col_name || '=' || temp_val, ' ; ') WITHIN GROUP (ORDER BY col_name) AS temp_matched_vals,
  -- helpful context: main full row and a sample temp full row
  ( SELECT 'JOB_APPLICATION=' || NVL(MAIN.JOB_APPLICATION,'<NULL>') || ', ' ||
           'CANDIDATE_ID=' || NVL(MAIN.CANDIDATE_ID,'<NULL>') || ', ' ||
           'POSITION=' || NVL(MAIN.POSITION,'<NULL>') || ', ' ||
           'EMPLOYEE_ID=' || NVL(MAIN.EMPLOYEE_ID,'<NULL>') || ', ' ||
           'SOEID=' || NVL(MAIN.SOEID,'<NULL>') || ', ' ||
           'JOB_REQUISITION=' || NVL(MAIN.JOB_REQUISITION,'<NULL>') || ', ' ||
           'ADDED_DATE=' || NVL(MAIN.ADDED_DATE,'<NULL>') || ', ' ||
           '...' -- you can extend if you want full long row here as in previous scripts
    FROM (SELECT * FROM main_norm mm WHERE mm.JOB_APPLICATION = p.JOB_APPLICATION
                                      AND mm.CANDIDATE_ID = p.CANDIDATE_ID
                                      AND mm.POSITION = p.POSITION
                                      AND mm.EMPLOYEE_ID = p.EMPLOYEE_ID
                                      AND mm.SOEID = p.SOEID
                                      AND mm.JOB_REQUISITION = p.JOB_REQUISITION
                                      AND mm.ADDED_DATE = p.ADDED_DATE
          ) MAIN
  ) AS main_full_row,
  ( SELECT MIN('JOB_APPLICATION=' || NVL(TT.JOB_APPLICATION,'<NULL>') || ', ' ||
               'CANDIDATE_ID=' || NVL(TT.CANDIDATE_ID,'<NULL>') || ', ' ||
               'POSITION=' || NVL(TT.POSITION,'<NULL>') || ', ' ||
               'EMPLOYEE_ID=' || NVL(TT.EMPLOYEE_ID,'<NULL>') || ', ' ||
               'SOEID=' || NVL(TT.SOEID,'<NULL>') || ', ' ||
               'JOB_REQUISITION=' || NVL(TT.JOB_REQUISITION,'<NULL>') || ', ' ||
               'ADDED_DATE=' || NVL(TT.ADDED_DATE,'<NULL>') ) 
    FROM temp_norm TT
    WHERE TT.JOB_APPLICATION = p.JOB_APPLICATION
      AND TT.CANDIDATE_ID = p.CANDIDATE_ID
      AND TT.POSITION = p.POSITION
      AND TT.EMPLOYEE_ID = p.EMPLOYEE_ID
      AND TT.SOEID = p.SOEID
      AND TT.JOB_REQUISITION = p.JOB_REQUISITION
      AND TT.ADDED_DATE = p.ADDED_DATE
  ) AS sample_temp_full_row
FROM per_col_matches p
GROUP BY p.JOB_APPLICATION, p.CANDIDATE_ID, p.POSITION, p.EMPLOYEE_ID, p.SOEID, p.JOB_REQUISITION, p.ADDED_DATE
ORDER BY match_count DESC, JOB_APPLICATION, CANDIDATE_ID;
