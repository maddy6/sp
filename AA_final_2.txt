✅ 1) Distinct count of JOB_APPLICATION in each table
-- MAIN
SELECT COUNT(DISTINCT TRIM(TO_CHAR(JOB_APPLICATION))) AS distinct_job_main
FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124';

-- TEMP
SELECT COUNT(DISTINCT TRIM(TO_CHAR(JOB_APPLICATION))) AS distinct_job_temp
FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124';

✅ 2) Distinct count of CANDIDATE_ID in each table
-- MAIN
SELECT COUNT(DISTINCT TRIM(TO_CHAR(CANDIDATE_ID))) AS distinct_cid_main
FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124';

-- TEMP
SELECT COUNT(DISTINCT TRIM(TO_CHAR(CANDIDATE_ID))) AS distinct_cid_temp
FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124';

✅ 3) JOB_APPLICATION & CANDIDATE_ID in MAIN but NOT in TEMP
-- JOB_APPLICATION
SELECT COUNT(*)
FROM (
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION)) AS job_app
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
  MINUS
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
);

-- CANDIDATE_ID
SELECT COUNT(*)
FROM (
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID)) AS cid
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
  MINUS
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
);

✅ 4) JOB_APPLICATION & CANDIDATE_ID in TEMP but NOT in MAIN
-- JOB_APPLICATION
SELECT COUNT(*)
FROM (
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
  MINUS
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
);

-- CANDIDATE_ID
SELECT COUNT(*)
FROM (
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
  MINUS
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
);

✅ 5) Common JOB_APPLICATION & CANDIDATE_ID in both tables
-- JOB_APPLICATION
SELECT COUNT(*)
FROM (
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
  INTERSECT
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
);

-- CANDIDATE_ID
SELECT COUNT(*)
FROM (
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
  INTERSECT
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID))
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
);

✔ OUTPUT YOU WILL GET

You will have exactly these 10 results:

distinct_job_main

distinct_job_temp

distinct_cid_main

distinct_cid_temp

job_apps_in_main_not_in_temp

cids_in_main_not_in_temp

job_apps_in_temp_not_in_main

cids_in_temp_not_in_main

common_job_apps

common_cids

If you want, I can also build a single combined summary table (one row with all 10 counts).

You said:
JOB_APPLICATION & CANDIDATE_ID in MAIN but NOT in TEMP

count & Missing %

JOB_APPLICATION & CANDIDATE_ID in Temp but NOT in Main

count & Missing %
ChatGPT said:

Here are exact, clean, minimum queries to give you:

✔ Count
✔ Missing %

for:

JOB_APPLICATION missing in TEMP

CANDIDATE_ID missing in TEMP

JOB_APPLICATION missing in MAIN

CANDIDATE_ID missing in MAIN

All queries use:

WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'

✅ 1) JOB_APPLICATION — MAIN → TEMP (Missing in TEMP)

Count + Missing %

WITH
main_jobs AS (
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION)) AS job_app
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),
temp_jobs AS (
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION)) AS job_app
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),
missing AS (
  SELECT job_app FROM main_jobs
  MINUS
  SELECT job_app FROM temp_jobs
)
SELECT
  (SELECT COUNT(*) FROM missing) AS missing_count,
  ROUND(
    (SELECT COUNT(*) FROM missing) * 100 /
    (SELECT COUNT(*) FROM main_jobs), 2
  ) AS missing_percent
FROM dual;

✅ 2) CANDIDATE_ID — MAIN → TEMP (Missing in TEMP)

Count + Missing %

WITH
main_cid AS (
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID)) AS cid
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),
temp_cid AS (
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID)) AS cid
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),
missing AS (
  SELECT cid FROM main_cid
  MINUS
  SELECT cid FROM temp_cid
)
SELECT
  (SELECT COUNT(*) FROM missing) AS missing_count,
  ROUND(
    (SELECT COUNT(*) FROM missing) * 100 /
    (SELECT COUNT(*) FROM main_cid), 2
  ) AS missing_percent
FROM dual;

✅ 3) JOB_APPLICATION — TEMP → MAIN (Missing in MAIN)

Count + Missing %

WITH
temp_jobs AS (
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION)) AS job_app
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),
main_jobs AS (
  SELECT DISTINCT TRIM(TO_CHAR(JOB_APPLICATION)) AS job_app
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),
missing AS (
  SELECT job_app FROM temp_jobs
  MINUS
  SELECT job_app FROM main_jobs
)
SELECT
  (SELECT COUNT(*) FROM missing) AS missing_count,
  ROUND(
    (SELECT COUNT(*) FROM missing) * 100 /
    (SELECT COUNT(*) FROM temp_jobs), 2
  ) AS missing_percent
FROM dual;

✅ 4) CANDIDATE_ID — TEMP → MAIN (Missing in MAIN)

Count + Missing %

WITH
temp_cid AS (
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID)) AS cid
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),
main_cid AS (
  SELECT DISTINCT TRIM(TO_CHAR(CANDIDATE_ID)) AS cid
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),
missing AS (
  SELECT cid FROM temp_cid
  MINUS
  SELECT cid FROM main_cid
)
SELECT
  (SELECT COUNT(*) FROM missing) AS missing_count,
  ROUND(
    (SELECT COUNT(*) FROM missing) * 100 /
    (SELECT COUNT(*) FROM temp_cid), 2
  ) AS missing_percent
FROM dual;




























--------------------------------------------------------------------------------
-- FINAL FULL: MAIN vs TEMP comparison (all 30 columns)
-- Filter ETL_BATCHID = '20251124'
-- Composite key used: JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE
--------------------------------------------------------------------------------

SET LONG 400000
SET PAGESIZE 200
-- adjust SETs as needed for your client

WITH

-- 0) normalize MAIN: convert to safe varchar-like values for comparison (dates as CHAR)
main_norm AS (
  SELECT
    TRIM(TO_CHAR(JOB_APPLICATION))     AS JOB_APPLICATION,
    TRIM(TO_CHAR(CANDIDATE_ID))        AS CANDIDATE_ID,
    TRIM(TO_CHAR(POSITION))            AS POSITION,
    TRIM(TO_CHAR(EMPLOYEE_ID))         AS EMPLOYEE_ID,
    TRIM(TO_CHAR(SOEID))               AS SOEID,
    TRIM(TO_CHAR(JOB_REQUISITION))     AS JOB_REQUISITION,
    TRIM(TO_CHAR(ADDED_DATE))          AS ADDED_DATE,
    TRIM(TO_CHAR(ORIGINAL_JOB_REQUISITION)) AS ORIGINAL_JOB_REQUISITION,
    TRIM(TO_CHAR(SOURCE_CATEGORY))     AS SOURCE_CATEGORY,
    TRIM(TO_CHAR(SOURCE))              AS SOURCE,
    TRIM(TO_CHAR(RECRUITING_AGENCY))   AS RECRUITING_AGENCY,
    TRIM(TO_CHAR(CANDIDATE_STATUS))    AS CANDIDATE_STATUS,
    TRIM(TO_CHAR(LAST_RECRUITING_STAGE)) AS LAST_RECRUITING_STAGE,
    TRIM(TO_CHAR(JOB_APPLICATION_STEP))   AS JOB_APPLICATION_STEP,
    TRIM(TO_CHAR(LAST_RECRUITING_STAGE_NUMBER)) AS LAST_RECRUITING_STAGE_NUMBER,
    TRIM(TO_CHAR(FINAL_DISPOSITION_REASON)) AS FINAL_DISPOSITION_REASON,
    TRIM(TO_CHAR(OFFER_STATUS))        AS OFFER_STATUS,
    TRIM(TO_CHAR(HIRED))               AS HIRED,
    TRIM(TO_CHAR(TIME_TO_OFFER_ACCEPT_DAYS)) AS TIME_TO_OFFER_ACCEPT_DAYS,
    TRIM(TO_CHAR(TIME_TO_OFFER_REJECT_DAYS)) AS TIME_TO_OFFER_REJECT_DAYS,
    TRIM(TO_CHAR(CANDIDATE_START_DATE)) AS CANDIDATE_START_DATE,
    TRIM(TO_CHAR(REFERRED_BY))         AS REFERRED_BY,
    TRIM(TO_CHAR(CREATED_DATE))        AS CREATED_DATE,
    TRIM(TO_CHAR(DATE_TIME_COMPLETED)) AS DATE_TIME_COMPLETED,
    TRIM(TO_CHAR(UPDATED_BY))          AS UPDATED_BY,
    TRIM(TO_CHAR(UPDATED_ON))          AS UPDATED_ON,
    TRIM(TO_CHAR(RECRUITER))           AS RECRUITER,
    TRIM(TO_CHAR(CANDIDATE_TAGS))      AS CANDIDATE_TAGS,
    TRIM(TO_CHAR(CANDIDATE_POOL))      AS CANDIDATE_POOL,
    TRIM(TO_CHAR(ETL_BATCHID))         AS ETL_BATCHID
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),

-- 0b) normalize TEMP
temp_norm AS (
  SELECT
    TRIM(TO_CHAR(JOB_APPLICATION))     AS JOB_APPLICATION,
    TRIM(TO_CHAR(CANDIDATE_ID))        AS CANDIDATE_ID,
    TRIM(TO_CHAR(POSITION))            AS POSITION,
    TRIM(TO_CHAR(EMPLOYEE_ID))         AS EMPLOYEE_ID,
    TRIM(TO_CHAR(SOEID))               AS SOEID,
    TRIM(TO_CHAR(JOB_REQUISITION))     AS JOB_REQUISITION,
    TRIM(TO_CHAR(ADDED_DATE))          AS ADDED_DATE,
    TRIM(TO_CHAR(ORIGINAL_JOB_REQUISITION)) AS ORIGINAL_JOB_REQUISITION,
    TRIM(TO_CHAR(SOURCE_CATEGORY))     AS SOURCE_CATEGORY,
    TRIM(TO_CHAR(SOURCE))              AS SOURCE,
    TRIM(TO_CHAR(RECRUITING_AGENCY))   AS RECRUITING_AGENCY,
    TRIM(TO_CHAR(CANDIDATE_STATUS))    AS CANDIDATE_STATUS,
    TRIM(TO_CHAR(LAST_RECRUITING_STAGE)) AS LAST_RECRUITING_STAGE,
    TRIM(TO_CHAR(JOB_APPLICATION_STEP))   AS JOB_APPLICATION_STEP,
    TRIM(TO_CHAR(LAST_RECRUITING_STAGE_NUMBER)) AS LAST_RECRUITING_STAGE_NUMBER,
    TRIM(TO_CHAR(FINAL_DISPOSITION_REASON)) AS FINAL_DISPOSITION_REASON,
    TRIM(TO_CHAR(OFFER_STATUS))        AS OFFER_STATUS,
    TRIM(TO_CHAR(HIRED))               AS HIRED,
    TRIM(TO_CHAR(TIME_TO_OFFER_ACCEPT_DAYS)) AS TIME_TO_OFFER_ACCEPT_DAYS,
    TRIM(TO_CHAR(TIME_TO_OFFER_REJECT_DAYS)) AS TIME_TO_OFFER_REJECT_DAYS,
    TRIM(TO_CHAR(CANDIDATE_START_DATE)) AS CANDIDATE_START_DATE,
    TRIM(TO_CHAR(REFERRED_BY))         AS REFERRED_BY,
    TRIM(TO_CHAR(CREATED_DATE))        AS CREATED_DATE,
    TRIM(TO_CHAR(DATE_TIME_COMPLETED)) AS DATE_TIME_COMPLETED,
    TRIM(TO_CHAR(UPDATED_BY))          AS UPDATED_BY,
    TRIM(TO_CHAR(UPDATED_ON))          AS UPDATED_ON,
    TRIM(TO_CHAR(RECRUITER))           AS RECRUITER,
    TRIM(TO_CHAR(CANDIDATE_TAGS))      AS CANDIDATE_TAGS,
    TRIM(TO_CHAR(CANDIDATE_POOL))      AS CANDIDATE_POOL,
    TRIM(TO_CHAR(ETL_BATCHID))         AS ETL_BATCHID
  FROM WFA_APP_USR_TALD.WD_JOBAPPLICATION_TEMP
  WHERE TRIM(TO_CHAR(ETL_BATCHID)) = '20251124'
),

--------------------------------------------------------------------------------
-- 1) Multiset summary (counts of full-row duplicates)
--------------------------------------------------------------------------------
gm AS (
  SELECT
    -- normalized full_row built from ALL 30 columns (same order as above)
    'JOB_APPLICATION=' || NVL(JOB_APPLICATION,'<NULL>') || '|' ||
    'CANDIDATE_ID=' || NVL(CANDIDATE_ID,'<NULL>') || '|' ||
    'POSITION=' || NVL(POSITION,'<NULL>') || '|' ||
    'EMPLOYEE_ID=' || NVL(EMPLOYEE_ID,'<NULL>') || '|' ||
    'SOEID=' || NVL(SOEID,'<NULL>') || '|' ||
    'JOB_REQUISITION=' || NVL(JOB_REQUISITION,'<NULL>') || '|' ||
    'ADDED_DATE=' || NVL(ADDED_DATE,'<NULL>') || '|' ||
    'ORIGINAL_JOB_REQUISITION=' || NVL(ORIGINAL_JOB_REQUISITION,'<NULL>') || '|' ||
    'SOURCE_CATEGORY=' || NVL(SOURCE_CATEGORY,'<NULL>') || '|' ||
    'SOURCE=' || NVL(SOURCE,'<NULL>') || '|' ||
    'RECRUITING_AGENCY=' || NVL(RECRUITING_AGENCY,'<NULL>') || '|' ||
    'CANDIDATE_STATUS=' || NVL(CANDIDATE_STATUS,'<NULL>') || '|' ||
    'LAST_RECRUITING_STAGE=' || NVL(LAST_RECRUITING_STAGE,'<NULL>') || '|' ||
    'JOB_APPLICATION_STEP=' || NVL(JOB_APPLICATION_STEP,'<NULL>') || '|' ||
    'LAST_RECRUITING_STAGE_NUMBER=' || NVL(LAST_RECRUITING_STAGE_NUMBER,'<NULL>') || '|' ||
    'FINAL_DISPOSITION_REASON=' || NVL(FINAL_DISPOSITION_REASON,'<NULL>') || '|' ||
    'OFFER_STATUS=' || NVL(OFFER_STATUS,'<NULL>') || '|' ||
    'HIRED=' || NVL(HIRED,'<NULL>') || '|' ||
    'TIME_TO_OFFER_ACCEPT_DAYS=' || NVL(TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>') || '|' ||
    'TIME_TO_OFFER_REJECT_DAYS=' || NVL(TIME_TO_OFFER_REJECT_DAYS,'<NULL>') || '|' ||
    'CANDIDATE_START_DATE=' || NVL(CANDIDATE_START_DATE,'<NULL>') || '|' ||
    'REFERRED_BY=' || NVL(REFERRED_BY,'<NULL>') || '|' ||
    'CREATED_DATE=' || NVL(CREATED_DATE,'<NULL>') || '|' ||
    'DATE_TIME_COMPLETED=' || NVL(DATE_TIME_COMPLETED,'<NULL>') || '|' ||
    'UPDATED_BY=' || NVL(UPDATED_BY,'<NULL>') || '|' ||
    'UPDATED_ON=' || NVL(UPDATED_ON,'<NULL>') || '|' ||
    'RECRUITER=' || NVL(RECRUITER,'<NULL>') || '|' ||
    'CANDIDATE_TAGS=' || NVL(CANDIDATE_TAGS,'<NULL>') || '|' ||
    'CANDIDATE_POOL=' || NVL(CANDIDATE_POOL,'<NULL>') || '|' ||
    'ETL_BATCHID=' || NVL(ETL_BATCHID,'<NULL>') AS full_row,
    COUNT(*) AS cnt_m
  FROM main_norm
  GROUP BY
    JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION,
    ADDED_DATE, ORIGINAL_JOB_REQUISITION, SOURCE_CATEGORY, SOURCE, RECRUITING_AGENCY,
    CANDIDATE_STATUS, LAST_RECRUITING_STAGE, JOB_APPLICATION_STEP, LAST_RECRUITING_STAGE_NUMBER,
    FINAL_DISPOSITION_REASON, OFFER_STATUS, HIRED, TIME_TO_OFFER_ACCEPT_DAYS,
    TIME_TO_OFFER_REJECT_DAYS, CANDIDATE_START_DATE, REFERRED_BY, CREATED_DATE,
    DATE_TIME_COMPLETED, UPDATED_BY, UPDATED_ON, RECRUITER, CANDIDATE_TAGS, CANDIDATE_POOL, ETL_BATCHID
),

gt AS (
  SELECT
    'JOB_APPLICATION=' || NVL(JOB_APPLICATION,'<NULL>') || '|' ||
    'CANDIDATE_ID=' || NVL(CANDIDATE_ID,'<NULL>') || '|' ||
    'POSITION=' || NVL(POSITION,'<NULL>') || '|' ||
    'EMPLOYEE_ID=' || NVL(EMPLOYEE_ID,'<NULL>') || '|' ||
    'SOEID=' || NVL(SOEID,'<NULL>') || '|' ||
    'JOB_REQUISITION=' || NVL(JOB_REQUISITION,'<NULL>') || '|' ||
    'ADDED_DATE=' || NVL(ADDED_DATE,'<NULL>') || '|' ||
    'ORIGINAL_JOB_REQUISITION=' || NVL(ORIGINAL_JOB_REQUISITION,'<NULL>') || '|' ||
    'SOURCE_CATEGORY=' || NVL(SOURCE_CATEGORY,'<NULL>') || '|' ||
    'SOURCE=' || NVL(SOURCE,'<NULL>') || '|' ||
    'RECRUITING_AGENCY=' || NVL(RECRUITING_AGENCY,'<NULL>') || '|' ||
    'CANDIDATE_STATUS=' || NVL(CANDIDATE_STATUS,'<NULL>') || '|' ||
    'LAST_RECRUITING_STAGE=' || NVL(LAST_RECRUITING_STAGE,'<NULL>') || '|' ||
    'JOB_APPLICATION_STEP=' || NVL(JOB_APPLICATION_STEP,'<NULL>') || '|' ||
    'LAST_RECRUITING_STAGE_NUMBER=' || NVL(LAST_RECRUITING_STAGE_NUMBER,'<NULL>') || '|' ||
    'FINAL_DISPOSITION_REASON=' || NVL(FINAL_DISPOSITION_REASON,'<NULL>') || '|' ||
    'OFFER_STATUS=' || NVL(OFFER_STATUS,'<NULL>') || '|' ||
    'HIRED=' || NVL(HIRED,'<NULL>') || '|' ||
    'TIME_TO_OFFER_ACCEPT_DAYS=' || NVL(TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>') || '|' ||
    'TIME_TO_OFFER_REJECT_DAYS=' || NVL(TIME_TO_OFFER_REJECT_DAYS,'<NULL>') || '|' ||
    'CANDIDATE_START_DATE=' || NVL(CANDIDATE_START_DATE,'<NULL>') || '|' ||
    'REFERRED_BY=' || NVL(REFERRED_BY,'<NULL>') || '|' ||
    'CREATED_DATE=' || NVL(CREATED_DATE,'<NULL>') || '|' ||
    'DATE_TIME_COMPLETED=' || NVL(DATE_TIME_COMPLETED,'<NULL>') || '|' ||
    'UPDATED_BY=' || NVL(UPDATED_BY,'<NULL>') || '|' ||
    'UPDATED_ON=' || NVL(UPDATED_ON,'<NULL>') || '|' ||
    'RECRUITER=' || NVL(RECRUITER,'<NULL>') || '|' ||
    'CANDIDATE_TAGS=' || NVL(CANDIDATE_TAGS,'<NULL>') || '|' ||
    'CANDIDATE_POOL=' || NVL(CANDIDATE_POOL,'<NULL>') || '|' ||
    'ETL_BATCHID=' || NVL(ETL_BATCHID,'<NULL>') AS full_row,
    COUNT(*) AS cnt_t
  FROM temp_norm
  GROUP BY
    JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION,
    ADDED_DATE, ORIGINAL_JOB_REQUISITION, SOURCE_CATEGORY, SOURCE, RECRUITING_AGENCY,
    CANDIDATE_STATUS, LAST_RECRUITING_STAGE, JOB_APPLICATION_STEP, LAST_RECRUITING_STAGE_NUMBER,
    FINAL_DISPOSITION_REASON, OFFER_STATUS, HIRED, TIME_TO_OFFER_ACCEPT_DAYS,
    TIME_TO_OFFER_REJECT_DAYS, CANDIDATE_START_DATE, REFERRED_BY, CREATED_DATE,
    DATE_TIME_COMPLETED, UPDATED_BY, UPDATED_ON, RECRUITER, CANDIDATE_TAGS, CANDIDATE_POOL, ETL_BATCHID
),

-- 1A) multiset summary single row
multiset_summary AS (
  SELECT
    (SELECT COUNT(*) FROM main_norm) AS total_main_rows,
    (SELECT SUM(LEAST(gm.cnt_m, NVL(gt.cnt_t,0)))
       FROM gm LEFT JOIN gt ON gm.full_row = gt.full_row) AS matched_rows_from_main_in_temp,
    (SELECT COUNT(*) FROM main_norm)
      - (SELECT SUM(LEAST(gm.cnt_m, NVL(gt.cnt_t,0)))
           FROM gm LEFT JOIN gt ON gm.full_row = gt.full_row) AS unmatched_main_rows
  FROM DUAL
),

-- 2) Which full_row strings are unmatched (gm.cnt_m > gt.cnt_t)
unmatched_fullrows AS (
  SELECT gm.full_row, gm.cnt_m AS main_count, NVL(gt.cnt_t,0) AS temp_count
  FROM gm LEFT JOIN gt ON gm.full_row = gt.full_row
  WHERE gm.cnt_m > NVL(gt.cnt_t,0)
),

-- 3) Representative MAIN row values for each unmatched full_row (pick one representative if duplicates exist)
unmatched_main_rows AS (
  SELECT
    u.full_row,
    u.main_count,
    u.temp_count,
    MIN(m.JOB_APPLICATION)     KEEP (DENSE_RANK FIRST ORDER BY NULL) AS JOB_APPLICATION,
    MIN(m.CANDIDATE_ID)        KEEP (DENSE_RANK FIRST ORDER BY NULL) AS CANDIDATE_ID,
    MIN(m.POSITION)            KEEP (DENSE_RANK FIRST ORDER BY NULL) AS POSITION,
    MIN(m.EMPLOYEE_ID)         KEEP (DENSE_RANK FIRST ORDER BY NULL) AS EMPLOYEE_ID,
    MIN(m.SOEID)               KEEP (DENSE_RANK FIRST ORDER BY NULL) AS SOEID,
    MIN(m.JOB_REQUISITION)     KEEP (DENSE_RANK FIRST ORDER BY NULL) AS JOB_REQUISITION,
    MIN(m.ADDED_DATE)          KEEP (DENSE_RANK FIRST ORDER BY NULL) AS ADDED_DATE,
    MIN(m.ORIGINAL_JOB_REQUISITION) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS ORIGINAL_JOB_REQUISITION,
    MIN(m.SOURCE_CATEGORY)     KEEP (DENSE_RANK FIRST ORDER BY NULL) AS SOURCE_CATEGORY,
    MIN(m.SOURCE)              KEEP (DENSE_RANK FIRST ORDER BY NULL) AS SOURCE,
    MIN(m.RECRUITING_AGENCY)   KEEP (DENSE_RANK FIRST ORDER BY NULL) AS RECRUITING_AGENCY,
    MIN(m.CANDIDATE_STATUS)    KEEP (DENSE_RANK FIRST ORDER BY NULL) AS CANDIDATE_STATUS,
    MIN(m.LAST_RECRUITING_STAGE) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS LAST_RECRUITING_STAGE,
    MIN(m.JOB_APPLICATION_STEP) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS JOB_APPLICATION_STEP,
    MIN(m.LAST_RECRUITING_STAGE_NUMBER) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS LAST_RECRUITING_STAGE_NUMBER,
    MIN(m.FINAL_DISPOSITION_REASON) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS FINAL_DISPOSITION_REASON,
    MIN(m.OFFER_STATUS)        KEEP (DENSE_RANK FIRST ORDER BY NULL) AS OFFER_STATUS,
    MIN(m.HIRED)               KEEP (DENSE_RANK FIRST ORDER BY NULL) AS HIRED,
    MIN(m.TIME_TO_OFFER_ACCEPT_DAYS) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS TIME_TO_OFFER_ACCEPT_DAYS,
    MIN(m.TIME_TO_OFFER_REJECT_DAYS) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS TIME_TO_OFFER_REJECT_DAYS,
    MIN(m.CANDIDATE_START_DATE) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS CANDIDATE_START_DATE,
    MIN(m.REFERRED_BY)         KEEP (DENSE_RANK FIRST ORDER BY NULL) AS REFERRED_BY,
    MIN(m.CREATED_DATE)        KEEP (DENSE_RANK FIRST ORDER BY NULL) AS CREATED_DATE,
    MIN(m.DATE_TIME_COMPLETED) KEEP (DENSE_RANK FIRST ORDER BY NULL) AS DATE_TIME_COMPLETED,
    MIN(m.UPDATED_BY)          KEEP (DENSE_RANK FIRST ORDER BY NULL) AS UPDATED_BY,
    MIN(m.UPDATED_ON)          KEEP (DENSE_RANK FIRST ORDER BY NULL) AS UPDATED_ON,
    MIN(m.RECRUITER)           KEEP (DENSE_RANK FIRST ORDER BY NULL) AS RECRUITER,
    MIN(m.CANDIDATE_TAGS)      KEEP (DENSE_RANK FIRST ORDER BY NULL) AS CANDIDATE_TAGS,
    MIN(m.CANDIDATE_POOL)      KEEP (DENSE_RANK FIRST ORDER BY NULL) AS CANDIDATE_POOL,
    MIN(m.ETL_BATCHID)         KEEP (DENSE_RANK FIRST ORDER BY NULL) AS ETL_BATCHID
  FROM unmatched_fullrows u
  JOIN main_norm m
    ON m.JOB_APPLICATION = REGEXP_SUBSTR(u.full_row,'JOB_APPLICATION=([^|]*)','1','1',NULL,1)
   AND m.CANDIDATE_ID    = REGEXP_SUBSTR(u.full_row,'CANDIDATE_ID=([^|]*)','1','1',NULL,1)
   AND m.POSITION        = REGEXP_SUBSTR(u.full_row,'POSITION=([^|]*)','1','1',NULL,1)
   AND m.EMPLOYEE_ID     = REGEXP_SUBSTR(u.full_row,'EMPLOYEE_ID=([^|]*)','1','1',NULL,1)
   AND m.SOEID           = REGEXP_SUBSTR(u.full_row,'SOEID=([^|]*)','1','1',NULL,1)
   AND m.JOB_REQUISITION = REGEXP_SUBSTR(u.full_row,'JOB_REQUISITION=([^|]*)','1','1',NULL,1)
   AND m.ADDED_DATE      = REGEXP_SUBSTR(u.full_row,'ADDED_DATE=([^|]*)','1','1',NULL,1)
  GROUP BY u.full_row, u.main_count, u.temp_count
),

--------------------------------------------------------------------------------
-- 4) For unmatched keys collect distinct TEMP values per column (comma-separated CLOB)
--     Use XMLAGG + XMLSERIALIZE to produce CLOB results (works across many Oracle versions)
--------------------------------------------------------------------------------
temp_values_agg AS (
  SELECT
    t.JOB_APPLICATION, t.CANDIDATE_ID, t.POSITION, t.EMPLOYEE_ID, t.SOEID, t.JOB_REQUISITION, t.ADDED_DATE,

    RTRIM(
      XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_ORIG || ', ') ORDER BY TEMP_ORIG) AS CLOB),
    ', ') AS temp_ORIGINAL_JOB_REQUISITION_vals,

    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_SC || ', ') ORDER BY TEMP_SC) AS CLOB), ', ') AS temp_SOURCE_CATEGORY_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_SOURCE || ', ') ORDER BY TEMP_SOURCE) AS CLOB), ', ') AS temp_SOURCE_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_RA || ', ') ORDER BY TEMP_RA) AS CLOB), ', ') AS temp_RECRUITING_AGENCY_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_CS || ', ') ORDER BY TEMP_CS) AS CLOB), ', ') AS temp_CANDIDATE_STATUS_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_LRS || ', ') ORDER BY TEMP_LRS) AS CLOB), ', ') AS temp_LAST_RECRUITING_STAGE_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_JAS || ', ') ORDER BY TEMP_JAS) AS CLOB), ', ') AS temp_JOB_APPLICATION_STEP_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_LRSN || ', ') ORDER BY TEMP_LRSN) AS CLOB), ', ') AS temp_LAST_RECRUITING_STAGE_NUMBER_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_FDR || ', ') ORDER BY TEMP_FDR) AS CLOB), ', ') AS temp_FINAL_DISPOSITION_REASON_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_OS || ', ') ORDER BY TEMP_OS) AS CLOB), ', ') AS temp_OFFER_STATUS_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_HIRED || ', ') ORDER BY TEMP_HIRED) AS CLOB), ', ') AS temp_HIRED_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_TA || ', ') ORDER BY TEMP_TA) AS CLOB), ', ') AS temp_TIME_TO_OFFER_ACCEPT_DAYS_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_TR || ', ') ORDER BY TEMP_TR) AS CLOB), ', ') AS temp_TIME_TO_OFFER_REJECT_DAYS_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_CSD || ', ') ORDER BY TEMP_CSD) AS CLOB), ', ') AS temp_CANDIDATE_START_DATE_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_REF || ', ') ORDER BY TEMP_REF) AS CLOB), ', ') AS temp_REFERRED_BY_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_CD || ', ') ORDER BY TEMP_CD) AS CLOB), ', ') AS temp_CREATED_DATE_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_DTC || ', ') ORDER BY TEMP_DTC) AS CLOB), ', ') AS temp_DATE_TIME_COMPLETED_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_UB || ', ') ORDER BY TEMP_UB) AS CLOB), ', ') AS temp_UPDATED_BY_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_UO || ', ') ORDER BY TEMP_UO) AS CLOB), ', ') AS temp_UPDATED_ON_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_REC || ', ') ORDER BY TEMP_REC) AS CLOB), ', ') AS temp_RECRUITER_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_CTAGS || ', ') ORDER BY TEMP_CTAGS) AS CLOB), ', ') AS temp_CANDIDATE_TAGS_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_CPOOL || ', ') ORDER BY TEMP_CPOOL) AS CLOB), ', ') AS temp_CANDIDATE_POOL_vals,
    RTRIM(XMLSERIALIZE(CONTENT XMLAGG(XMLELEMENT(e, TEMP_ETL || ', ') ORDER BY TEMP_ETL) AS CLOB), ', ') AS temp_ETL_BATCHID_vals

  FROM (
    SELECT DISTINCT
      JOB_APPLICATION, CANDIDATE_ID, POSITION, EMPLOYEE_ID, SOEID, JOB_REQUISITION, ADDED_DATE,
      NVL(ORIGINAL_JOB_REQUISITION,'<NULL>') AS TEMP_ORIG,
      NVL(SOURCE_CATEGORY,'<NULL>') AS TEMP_SC,
      NVL(SOURCE,'<NULL>') AS TEMP_SOURCE,
      NVL(RECRUITING_AGENCY,'<NULL>') AS TEMP_RA,
      NVL(CANDIDATE_STATUS,'<NULL>') AS TEMP_CS,
      NVL(LAST_RECRUITING_STAGE,'<NULL>') AS TEMP_LRS,
      NVL(JOB_APPLICATION_STEP,'<NULL>') AS TEMP_JAS,
      NVL(LAST_RECRUITING_STAGE_NUMBER,'<NULL>') AS TEMP_LRSN,
      NVL(FINAL_DISPOSITION_REASON,'<NULL>') AS TEMP_FDR,
      NVL(OFFER_STATUS,'<NULL>') AS TEMP_OS,
      NVL(HIRED,'<NULL>') AS TEMP_HIRED,
      NVL(TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>') AS TEMP_TA,
      NVL(TIME_TO_OFFER_REJECT_DAYS,'<NULL>') AS TEMP_TR,
      NVL(CANDIDATE_START_DATE,'<NULL>') AS TEMP_CSD,
      NVL(REFERRED_BY,'<NULL>') AS TEMP_REF,
      NVL(CREATED_DATE,'<NULL>') AS TEMP_CD,
      NVL(DATE_TIME_COMPLETED,'<NULL>') AS TEMP_DTC,
      NVL(UPDATED_BY,'<NULL>') AS TEMP_UB,
      NVL(UPDATED_ON,'<NULL>') AS TEMP_UO,
      NVL(RECRUITER,'<NULL>') AS TEMP_REC,
      NVL(CANDIDATE_TAGS,'<NULL>') AS TEMP_CTAGS,
      NVL(CANDIDATE_POOL,'<NULL>') AS TEMP_CPOOL,
      NVL(ETL_BATCHID,'<NULL>') AS TEMP_ETL
    FROM temp_norm
  ) t
  GROUP BY t.JOB_APPLICATION, t.CANDIDATE_ID, t.POSITION, t.EMPLOYEE_ID, t.SOEID, t.JOB_REQUISITION, t.ADDED_DATE
)

--------------------------------------------------------------------------------
-- Final detailed unmatched report:
-- Show per-unmatched-main-key the columns that differ, main value and aggregated temp distinct values
--------------------------------------------------------------------------------
SELECT
  u.full_row                                        AS main_full_row_string,
  u.main_count,
  u.temp_count,
  um.JOB_APPLICATION,
  um.CANDIDATE_ID,
  um.POSITION,
  um.EMPLOYEE_ID,
  um.SOEID,
  um.JOB_REQUISITION,
  um.ADDED_DATE,

  -- For each column: show a marker (column name) if main value not present in aggregated temp values,
  -- then show main value and temp aggregated distinct values.
  CASE WHEN instr(tva.temp_ORIGINAL_JOB_REQUISITION_vals, um.ORIGINAL_JOB_REQUISITION) = 0 THEN 'ORIGINAL_JOB_REQUISITION' END AS diff_col_original_job_requisition,
  um.ORIGINAL_JOB_REQUISITION AS main_original_job_requisition,
  tva.temp_ORIGINAL_JOB_REQUISITION_vals AS temp_original_job_requisition_vals,

  CASE WHEN instr(tva.temp_SOURCE_CATEGORY_vals, um.SOURCE_CATEGORY) = 0 THEN 'SOURCE_CATEGORY' END AS diff_col_source_category,
  um.SOURCE_CATEGORY AS main_source_category,
  tva.temp_SOURCE_CATEGORY_vals AS temp_source_category_vals,

  CASE WHEN instr(tva.temp_SOURCE_vals, um.SOURCE) = 0 THEN 'SOURCE' END AS diff_col_source,
  um.SOURCE AS main_source,
  tva.temp_SOURCE_vals AS temp_source_vals,

  CASE WHEN instr(tva.temp_RECRUITING_AGENCY_vals, um.RECRUITING_AGENCY) = 0 THEN 'RECRUITING_AGENCY' END AS diff_col_recruiting_agency,
  um.RECRUITING_AGENCY AS main_recruiting_agency,
  tva.temp_RECRUITING_AGENCY_vals AS temp_recruiting_agency_vals,

  CASE WHEN instr(tva.temp_CANDIDATE_STATUS_vals, um.CANDIDATE_STATUS) = 0 THEN 'CANDIDATE_STATUS' END AS diff_col_candidate_status,
  um.CANDIDATE_STATUS AS main_candidate_status,
  tva.temp_CANDIDATE_STATUS_vals AS temp_candidate_status_vals,

  CASE WHEN instr(tva.temp_LAST_RECRUITING_STAGE_vals, um.LAST_RECRUITING_STAGE) = 0 THEN 'LAST_RECRUITING_STAGE' END AS diff_col_last_recruiting_stage,
  um.LAST_RECRUITING_STAGE AS main_last_recruiting_stage,
  tva.temp_LAST_RECRUITING_STAGE_vals AS temp_last_recruiting_stage_vals,

  CASE WHEN instr(tva.temp_JOB_APPLICATION_STEP_vals, um.JOB_APPLICATION_STEP) = 0 THEN 'JOB_APPLICATION_STEP' END AS diff_col_job_application_step,
  um.JOB_APPLICATION_STEP AS main_job_application_step,
  tva.temp_JOB_APPLICATION_STEP_vals AS temp_job_application_step_vals,

  CASE WHEN instr(tva.temp_LAST_RECRUITING_STAGE_NUMBER_vals, um.LAST_RECRUITING_STAGE_NUMBER) = 0 THEN 'LAST_RECRUITING_STAGE_NUMBER' END AS diff_col_last_recruiting_stage_number,
  um.LAST_RECRUITING_STAGE_NUMBER AS main_last_recruiting_stage_number,
  tva.temp_LAST_RECRUITING_STAGE_NUMBER_vals AS temp_last_recruiting_stage_number_vals,

  CASE WHEN instr(tva.temp_FINAL_DISPOSITION_REASON_vals, um.FINAL_DISPOSITION_REASON) = 0 THEN 'FINAL_DISPOSITION_REASON' END AS diff_col_final_disposition_reason,
  um.FINAL_DISPOSITION_REASON AS main_final_disposition_reason,
  tva.temp_FINAL_DISPOSITION_REASON_vals AS temp_final_disposition_reason_vals,

  CASE WHEN instr(tva.temp_OFFER_STATUS_vals, um.OFFER_STATUS) = 0 THEN 'OFFER_STATUS' END AS diff_col_offer_status,
  um.OFFER_STATUS AS main_offer_status,
  tva.temp_OFFER_STATUS_vals AS temp_offer_status_vals,

  CASE WHEN instr(tva.temp_HIRED_vals, um.HIRED) = 0 THEN 'HIRED' END AS diff_col_hired,
  um.HIRED AS main_hired,
  tva.temp_HIRED_vals AS temp_hired_vals,

  CASE WHEN instr(tva.temp_TIME_TO_OFFER_ACCEPT_DAYS_vals, um.TIME_TO_OFFER_ACCEPT_DAYS) = 0 THEN 'TIME_TO_OFFER_ACCEPT_DAYS' END AS diff_col_time_to_offer_accept_days,
  um.TIME_TO_OFFER_ACCEPT_DAYS AS main_time_to_offer_accept_days,
  tva.temp_TIME_TO_OFFER_ACCEPT_DAYS_vals AS temp_time_to_offer_accept_days_vals,

  CASE WHEN instr(tva.temp_TIME_TO_OFFER_REJECT_DAYS_vals, um.TIME_TO_OFFER_REJECT_DAYS) = 0 THEN 'TIME_TO_OFFER_REJECT_DAYS' END AS diff_col_time_to_offer_reject_days,
  um.TIME_TO_OFFER_REJECT_DAYS AS main_time_to_offer_reject_days,
  tva.temp_TIME_TO_OFFER_REJECT_DAYS_vals AS temp_time_to_offer_reject_days_vals,

  CASE WHEN instr(tva.temp_CANDIDATE_START_DATE_vals, um.CANDIDATE_START_DATE) = 0 THEN 'CANDIDATE_START_DATE' END AS diff_col_candidate_start_date,
  um.CANDIDATE_START_DATE AS main_candidate_start_date,
  tva.temp_CANDIDATE_START_DATE_vals AS temp_candidate_start_date_vals,

  CASE WHEN instr(tva.temp_REFERRED_BY_vals, um.REFERRED_BY) = 0 THEN 'REFERRED_BY' END AS diff_col_referred_by,
  um.REFERRED_BY AS main_referred_by,
  tva.temp_REFERRED_BY_vals AS temp_referred_by_vals,

  CASE WHEN instr(tva.temp_CREATED_DATE_vals, um.CREATED_DATE) = 0 THEN 'CREATED_DATE' END AS diff_col_created_date,
  um.CREATED_DATE AS main_created_date,
  tva.temp_CREATED_DATE_vals AS temp_created_date_vals,

  CASE WHEN instr(tva.temp_DATE_TIME_COMPLETED_vals, um.DATE_TIME_COMPLETED) = 0 THEN 'DATE_TIME_COMPLETED' END AS diff_col_date_time_completed,
  um.DATE_TIME_COMPLETED AS main_date_time_completed,
  tva.temp_DATE_TIME_COMPLETED_vals AS temp_date_time_completed_vals,

  CASE WHEN instr(tva.temp_UPDATED_BY_vals, um.UPDATED_BY) = 0 THEN 'UPDATED_BY' END AS diff_col_updated_by,
  um.UPDATED_BY AS main_updated_by,
  tva.temp_UPDATED_BY_vals AS temp_updated_by_vals,

  CASE WHEN instr(tva.temp_UPDATED_ON_vals, um.UPDATED_ON) = 0 THEN 'UPDATED_ON' END AS diff_col_updated_on,
  um.UPDATED_ON AS main_updated_on,
  tva.temp_UPDATED_ON_vals AS temp_updated_on_vals,

  CASE WHEN instr(tva.temp_RECRUITER_vals, um.RECRUITER) = 0 THEN 'RECRUITER' END AS diff_col_recruiter,
  um.RECRUITER AS main_recruiter,
  tva.temp_RECRUITER_vals AS temp_recruiter_vals,

  CASE WHEN instr(tva.temp_CANDIDATE_TAGS_vals, um.CANDIDATE_TAGS) = 0 THEN 'CANDIDATE_TAGS' END AS diff_col_candidate_tags,
  um.CANDIDATE_TAGS AS main_candidate_tags,
  tva.temp_CANDIDATE_TAGS_vals AS temp_candidate_tags_vals,

  CASE WHEN instr(tva.temp_CANDIDATE_POOL_vals, um.CANDIDATE_POOL) = 0 THEN 'CANDIDATE_POOL' END AS diff_col_candidate_pool,
  um.CANDIDATE_POOL AS main_candidate_pool,
  tva.temp_CANDIDATE_POOL_vals AS temp_candidate_pool_vals,

  CASE WHEN instr(tva.temp_ETL_BATCHID_vals, um.ETL_BATCHID) = 0 THEN 'ETL_BATCHID' END AS diff_col_etl_batchid,
  um.ETL_BATCHID AS main_etl_batchid,
  tva.temp_ETL_BATCHID_vals AS temp_etl_batchid_vals

FROM unmatched_fullrows u
LEFT JOIN unmatched_main_rows um ON u.full_row = um.full_row
LEFT JOIN temp_values_agg tva
  ON tva.JOB_APPLICATION = um.JOB_APPLICATION
 AND tva.CANDIDATE_ID    = um.CANDIDATE_ID
 AND tva.POSITION        = um.POSITION
 AND tva.EMPLOYEE_ID     = um.EMPLOYEE_ID
 AND tva.SOEID           = um.SOEID
 AND tva.JOB_REQUISITION = um.JOB_REQUISITION
 AND tva.ADDED_DATE      = um.ADDED_DATE
ORDER BY u.main_count DESC
;

--------------------------------------------------------------------------------
-- OPTIONAL: Quick single-number count of unmatched MAIN rows (run separately if you want)
--------------------------------------------------------------------------------
-- SELECT (SELECT COUNT(*) FROM main_norm) - (SELECT SUM(LEAST(gm.cnt_m, NVL(gt.cnt_t,0))) FROM gm LEFT JOIN gt ON gm.full_row = gt.full_row) AS unmatched_main_rows FROM DUAL;

--------------------------------------------------------------------------------
-- MATCHING-KEYS report: keys present in both MAIN & TEMP and showing columns that matched
-- (One row per composite key that appears in both; lists matching columns and the values)
-- NOTE: This is heavy - run separately if needed.
--------------------------------------------------------------------------------
-- The following block builds per-column matches (one row per matched column per matching key),
-- then aggregates to one line per key with LISTAGG of matched columns and their values.
SELECT
  p.JOB_APPLICATION, p.CANDIDATE_ID, p.POSITION, p.EMPLOYEE_ID, p.SOEID, p.JOB_REQUISITION, p.ADDED_DATE,
  COUNT(*) AS match_count,
  LISTAGG(col_name, ', ') WITHIN GROUP (ORDER BY col_name) AS matching_columns,
  LISTAGG(col_name || '=' || main_val, ' ; ') WITHIN GROUP (ORDER BY col_name) AS main_matched_vals,
  LISTAGG(col_name || '=' || temp_val, ' ; ') WITHIN GROUP (ORDER BY col_name) AS temp_matched_vals
FROM (
  -- ORIGINAL_JOB_REQUISITION
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'ORIGINAL_JOB_REQUISITION' AS col_name,
         NVL(m.ORIGINAL_JOB_REQUISITION,'<NULL>') AS main_val,
         NVL(t.ORIGINAL_JOB_REQUISITION,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.ORIGINAL_JOB_REQUISITION,'<NULL>') = NVL(t.ORIGINAL_JOB_REQUISITION,'<NULL>')

  UNION ALL

  -- SOURCE_CATEGORY
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'SOURCE_CATEGORY' AS col_name,
         NVL(m.SOURCE_CATEGORY,'<NULL>') AS main_val,
         NVL(t.SOURCE_CATEGORY,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.SOURCE_CATEGORY,'<NULL>') = NVL(t.SOURCE_CATEGORY,'<NULL>')

  UNION ALL

  -- SOURCE
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'SOURCE' AS col_name,
         NVL(m.SOURCE,'<NULL>') AS main_val,
         NVL(t.SOURCE,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.SOURCE,'<NULL>') = NVL(t.SOURCE,'<NULL>')

  UNION ALL

  -- RECRUITING_AGENCY
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'RECRUITING_AGENCY' AS col_name,
         NVL(m.RECRUITING_AGENCY,'<NULL>') AS main_val,
         NVL(t.RECRUITING_AGENCY,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.RECRUITING_AGENCY,'<NULL>') = NVL(t.RECRUITING_AGENCY,'<NULL>')

  UNION ALL

  -- CANDIDATE_STATUS
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'CANDIDATE_STATUS' AS col_name,
         NVL(m.CANDIDATE_STATUS,'<NULL>') AS main_val,
         NVL(t.CANDIDATE_STATUS,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.CANDIDATE_STATUS,'<NULL>') = NVL(t.CANDIDATE_STATUS,'<NULL>')

  UNION ALL

  -- LAST_RECRUITING_STAGE
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'LAST_RECRUITING_STAGE' AS col_name,
         NVL(m.LAST_RECRUITING_STAGE,'<NULL>') AS main_val,
         NVL(t.LAST_RECRUITING_STAGE,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.LAST_RECRUITING_STAGE,'<NULL>') = NVL(t.LAST_RECRUITING_STAGE,'<NULL>')

  UNION ALL

  -- JOB_APPLICATION_STEP
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'JOB_APPLICATION_STEP' AS col_name,
         NVL(m.JOB_APPLICATION_STEP,'<NULL>') AS main_val,
         NVL(t.JOB_APPLICATION_STEP,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.JOB_APPLICATION_STEP,'<NULL>') = NVL(t.JOB_APPLICATION_STEP,'<NULL>')

  UNION ALL

  -- LAST_RECRUITING_STAGE_NUMBER
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'LAST_RECRUITING_STAGE_NUMBER' AS col_name,
         NVL(m.LAST_RECRUITING_STAGE_NUMBER,'<NULL>') AS main_val,
         NVL(t.LAST_RECRUITING_STAGE_NUMBER,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.LAST_RECRUITING_STAGE_NUMBER,'<NULL>') = NVL(t.LAST_RECRUITING_STAGE_NUMBER,'<NULL>')

  UNION ALL

  -- FINAL_DISPOSITION_REASON
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'FINAL_DISPOSITION_REASON' AS col_name,
         NVL(m.FINAL_DISPOSITION_REASON,'<NULL>') AS main_val,
         NVL(t.FINAL_DISPOSITION_REASON,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.FINAL_DISPOSITION_REASON,'<NULL>') = NVL(t.FINAL_DISPOSITION_REASON,'<NULL>')

  UNION ALL

  -- OFFER_STATUS
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'OFFER_STATUS' AS col_name,
         NVL(m.OFFER_STATUS,'<NULL>') AS main_val,
         NVL(t.OFFER_STATUS,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.OFFER_STATUS,'<NULL>') = NVL(t.OFFER_STATUS,'<NULL>')

  UNION ALL

  -- HIRED
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'HIRED' AS col_name,
         NVL(m.HIRED,'<NULL>') AS main_val,
         NVL(t.HIRED,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.HIRED,'<NULL>') = NVL(t.HIRED,'<NULL>')

  UNION ALL

  -- TIME_TO_OFFER_ACCEPT_DAYS
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'TIME_TO_OFFER_ACCEPT_DAYS' AS col_name,
         NVL(m.TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>') AS main_val,
         NVL(t.TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>') = NVL(t.TIME_TO_OFFER_ACCEPT_DAYS,'<NULL>')

  UNION ALL

  -- TIME_TO_OFFER_REJECT_DAYS
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'TIME_TO_OFFER_REJECT_DAYS' AS col_name,
         NVL(m.TIME_TO_OFFER_REJECT_DAYS,'<NULL>') AS main_val,
         NVL(t.TIME_TO_OFFER_REJECT_DAYS,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.TIME_TO_OFFER_REJECT_DAYS,'<NULL>') = NVL(t.TIME_TO_OFFER_REJECT_DAYS,'<NULL>')

  UNION ALL

  -- CANDIDATE_START_DATE
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'CANDIDATE_START_DATE' AS col_name,
         NVL(m.CANDIDATE_START_DATE,'<NULL>') AS main_val,
         NVL(t.CANDIDATE_START_DATE,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.CANDIDATE_START_DATE,'<NULL>') = NVL(t.CANDIDATE_START_DATE,'<NULL>')

  UNION ALL

  -- REFERRED_BY
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'REFERRED_BY' AS col_name,
         NVL(m.REFERRED_BY,'<NULL>') AS main_val,
         NVL(t.REFERRED_BY,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.REFERRED_BY,'<NULL>') = NVL(t.REFERRED_BY,'<NULL>')

  UNION ALL

  -- CREATED_DATE
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'CREATED_DATE' AS col_name,
         NVL(m.CREATED_DATE,'<NULL>') AS main_val,
         NVL(t.CREATED_DATE,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.CREATED_DATE,'<NULL>') = NVL(t.CREATED_DATE,'<NULL>')

  UNION ALL

  -- DATE_TIME_COMPLETED
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'DATE_TIME_COMPLETED' AS col_name,
         NVL(m.DATE_TIME_COMPLETED,'<NULL>') AS main_val,
         NVL(t.DATE_TIME_COMPLETED,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.DATE_TIME_COMPLETED,'<NULL>') = NVL(t.DATE_TIME_COMPLETED,'<NULL>')

  UNION ALL

  -- UPDATED_BY
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'UPDATED_BY' AS col_name,
         NVL(m.UPDATED_BY,'<NULL>') AS main_val,
         NVL(t.UPDATED_BY,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.UPDATED_BY,'<NULL>') = NVL(t.UPDATED_BY,'<NULL>')

  UNION ALL

  -- UPDATED_ON
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'UPDATED_ON' AS col_name,
         NVL(m.UPDATED_ON,'<NULL>') AS main_val,
         NVL(t.UPDATED_ON,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.UPDATED_ON,'<NULL>') = NVL(t.UPDATED_ON,'<NULL>')

  UNION ALL

  -- RECRUITER
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'RECRUITER' AS col_name,
         NVL(m.RECRUITER,'<NULL>') AS main_val,
         NVL(t.RECRUITER,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.RECRUITER,'<NULL>') = NVL(t.RECRUITER,'<NULL>')

  UNION ALL

  -- CANDIDATE_TAGS
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'CANDIDATE_TAGS' AS col_name,
         NVL(m.CANDIDATE_TAGS,'<NULL>') AS main_val,
         NVL(t.CANDIDATE_TAGS,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.CANDIDATE_TAGS,'<NULL>') = NVL(t.CANDIDATE_TAGS,'<NULL>')

  UNION ALL

  -- CANDIDATE_POOL
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'CANDIDATE_POOL' AS col_name,
         NVL(m.CANDIDATE_POOL,'<NULL>') AS main_val,
         NVL(t.CANDIDATE_POOL,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.CANDIDATE_POOL,'<NULL>') = NVL(t.CANDIDATE_POOL,'<NULL>')

  UNION ALL

  -- ETL_BATCHID
  SELECT m.JOB_APPLICATION, m.CANDIDATE_ID, m.POSITION, m.EMPLOYEE_ID, m.SOEID, m.JOB_REQUISITION, m.ADDED_DATE,
         'ETL_BATCHID' AS col_name,
         NVL(m.ETL_BATCHID,'<NULL>') AS main_val,
         NVL(t.ETL_BATCHID,'<NULL>') AS temp_val
  FROM main_norm m JOIN temp_norm t
    ON m.JOB_APPLICATION = t.JOB_APPLICATION
   AND m.CANDIDATE_ID    = t.CANDIDATE_ID
   AND m.POSITION        = t.POSITION
   AND m.EMPLOYEE_ID     = t.EMPLOYEE_ID
   AND m.SOEID           = t.SOEID
   AND m.JOB_REQUISITION = t.JOB_REQUISITION
   AND m.ADDED_DATE      = t.ADDED_DATE
  WHERE NVL(m.ETL_BATCHID,'<NULL>') = NVL(t.ETL_BATCHID,'<NULL>')

) p
GROUP BY p.JOB_APPLICATION, p.CANDIDATE_ID, p.POSITION, p.EMPLOYEE_ID, p.SOEID, p.JOB_REQUISITION, p.ADDED_DATE
ORDER BY match_count DESC
;

--------------------------------------------------------------------------------
-- END OF SCRIPT
--------------------------------------------------------------------------------
