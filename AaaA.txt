SET SERVEROUTPUT ON
DECLARE
    v_cols   CLOB;
    v_sql    CLOB;
BEGIN
    /* 1. Build column list dynamically */
    SELECT
        LISTAGG(column_name, ',') WITHIN GROUP (ORDER BY column_id)
    INTO v_cols
    FROM all_tab_columns
    WHERE owner = 'WFA_APP_USR_TALD'
      AND table_name = 'WD_RECRUITING_DIVERSE_INTERVIEW_PANELS'
      AND column_name NOT IN (
            'CANDIDATE_ID',
            'JOB_APPLICATION',
            'JOB_REQ_ID',
            'JOB_REQ_OPEN_DATE',
            'INGESTED_DATE'
      );

    /* 2. Build final SQL */
    v_sql :=
    '
    SELECT
        a.CANDIDATE_ID      AS X1,
        a.JOB_APPLICATION   AS X2,
        a.JOB_REQ_ID        AS X3,
        a.JOB_REQ_OPEN_DATE AS X4,
        a.INGESTED_DATE     AS X5,

        COUNT(*) AS MISMATCH_COLUMN_COUNT,

        RTRIM(
            XMLAGG(
                XMLELEMENT(e, col || '','')
                ORDER BY col
            ).EXTRACT(''//text()'').GETCLOBVAL(),
        '','') AS MISMATCH_COLUMNS,

        RTRIM(
            XMLAGG(
                XMLELEMENT(e, col || '':'' || aval || '','')
                ORDER BY col
            ).EXTRACT(''//text()'').GETCLOBVAL(),
        '','') AS VALUES_IN_MAIN,

        RTRIM(
            XMLAGG(
                XMLELEMENT(e, col || '':'' || bval || '','')
                ORDER BY col
            ).EXTRACT(''//text()'').GETCLOBVAL(),
        '','') AS VALUES_IN_TEMP

    FROM (
        SELECT
            a.CANDIDATE_ID,
            a.JOB_APPLICATION,
            a.JOB_REQ_ID,
            a.JOB_REQ_OPEN_DATE,
            a.INGESTED_DATE,
            col,
            aval,
            bval
        FROM
            WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS a
        JOIN
            WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS_TEMP b
        ON  a.CANDIDATE_ID      = b.CANDIDATE_ID
        AND a.JOB_APPLICATION   = b.JOB_APPLICATION
        AND a.JOB_REQ_ID        = b.JOB_REQ_ID
        AND a.JOB_REQ_OPEN_DATE = b.JOB_REQ_OPEN_DATE
        AND a.INGESTED_DATE     = b.INGESTED_DATE

        UNPIVOT INCLUDE NULLS (
            aval FOR col IN (' || v_cols || ')
        )
        JOIN (
            SELECT *
            FROM WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS_TEMP
            UNPIVOT INCLUDE NULLS (
                bval FOR col IN (' || v_cols || ')
            )
        ) t
        USING (
            CANDIDATE_ID,
            JOB_APPLICATION,
            JOB_REQ_ID,
            JOB_REQ_OPEN_DATE,
            INGESTED_DATE,
            col
        )
        WHERE NVL(TO_CHAR(aval), ''#NULL#'')
           <> NVL(TO_CHAR(bval), ''#NULL#'')
    )
    GROUP BY
        CANDIDATE_ID,
        JOB_APPLICATION,
        JOB_REQ_ID,
        JOB_REQ_OPEN_DATE,
        INGESTED_DATE
    ORDER BY
        CANDIDATE_ID,
        JOB_APPLICATION
    ';

    -- Uncomment to debug SQL
    -- DBMS_OUTPUT.PUT_LINE(v_sql);

    EXECUTE IMMEDIATE v_sql;
END;
/



















SET SERVEROUTPUT ON
DECLARE
    v_sql CLOB;
BEGIN
    SELECT
        'SELECT
            a.CANDIDATE_ID        AS X1,
            a.JOB_APPLICATION     AS X2,
            a.JOB_REQ_ID          AS X3,
            a.JOB_REQ_OPEN_DATE   AS X4,
            a.INGESTED_DATE       AS X5,

            COUNT(*) AS MISMATCH_COLUMN_COUNT,

            RTRIM(
                XMLAGG(
                    XMLELEMENT(e, col_name || '','')
                    ORDER BY col_name
                ).EXTRACT(''//text()'').GETCLOBVAL(),
            '','') AS MISMATCH_COLUMNS,

            RTRIM(
                XMLAGG(
                    XMLELEMENT(e, col_name || '':'' || a_val || '','')
                    ORDER BY col_name
                ).EXTRACT(''//text()'').GETCLOBVAL(),
            '','') AS VALUES_IN_MAIN,

            RTRIM(
                XMLAGG(
                    XMLELEMENT(e, col_name || '':'' || b_val || '','')
                    ORDER BY col_name
                ).EXTRACT(''//text()'').GETCLOBVAL(),
            '','') AS VALUES_IN_TEMP

        FROM (
            ' ||

        XMLAGG(
            XMLELEMENT(
                e,
                '
                SELECT
                    a.CANDIDATE_ID,
                    a.JOB_APPLICATION,
                    a.JOB_REQ_ID,
                    a.JOB_REQ_OPEN_DATE,
                    a.INGESTED_DATE,
                    ''' || column_name || ''' AS col_name,
                    TO_CHAR(a.' || column_name || ') AS a_val,
                    TO_CHAR(b.' || column_name || ') AS b_val
                FROM WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS a
                JOIN WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS_TEMP b
                  ON a.CANDIDATE_ID      = b.CANDIDATE_ID
                 AND a.JOB_APPLICATION   = b.JOB_APPLICATION
                 AND a.JOB_REQ_ID        = b.JOB_REQ_ID
                 AND a.JOB_REQ_OPEN_DATE = b.JOB_REQ_OPEN_DATE
                 AND a.INGESTED_DATE     = b.INGESTED_DATE
                WHERE NVL(TO_CHAR(a.' || column_name || '), ''#NULL#'')
                   <> NVL(TO_CHAR(b.' || column_name || '), ''#NULL#'')
                UNION ALL
                '
            )
            ORDER BY column_id
        ).EXTRACT('//text()').GETCLOBVAL()

        || '
            SELECT 1 FROM dual WHERE 1=0
        )
        GROUP BY
            CANDIDATE_ID,
            JOB_APPLICATION,
            JOB_REQ_ID,
            JOB_REQ_OPEN_DATE,
            INGESTED_DATE
        ORDER BY
            CANDIDATE_ID,
            JOB_APPLICATION'
    INTO v_sql
    FROM all_tab_columns
    WHERE owner = 'WFA_APP_USR_TALD'
      AND table_name = 'WD_RECRUITING_DIVERSE_INTERVIEW_PANELS'
      AND column_name NOT IN (
            'CANDIDATE_ID',
            'JOB_APPLICATION',
            'JOB_REQ_ID',
            'JOB_REQ_OPEN_DATE',
            'INGESTED_DATE'
      );

    -- Uncomment to debug generated SQL
    -- DBMS_OUTPUT.PUT_LINE(v_sql);

    EXECUTE IMMEDIATE v_sql;
END;
/









SELECT column_name
FROM all_tab_columns
WHERE owner = 'WFA_APP_USR_TALD'
  AND table_name = 'WD_RECRUITING_DIVERSE_INTERVIEW_PANELS'
ORDER BY column_id;





DECLARE
    v_sql CLOB;
BEGIN
    -- Build the dynamic SQL
    SELECT 'WITH cols AS (
              SELECT column_name
              FROM all_tab_columns
              WHERE owner = ''WFA_APP_USR_TALD''
                AND table_name = ''WD_RECRUITING_DIVERSE_INTERVIEW_PANELS''
                AND column_name NOT IN (''X1'',''X2'',''X3'',''X4'',''X5'')
            ),
            diff AS (
                SELECT 
                    A.X1, A.X2, A.X3, A.X4, A.X5,' ||
                    LISTAGG('
                    CASE WHEN NVL(A.' || column_name || ', ''#NULL#'') 
                               <> NVL(B.' || column_name || ', ''#NULL#'') 
                         THEN ''' || column_name || ''' END AS ' || column_name, ',') 
                    WITHIN GROUP (ORDER BY column_name)
            || ' 
                FROM WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS A
                JOIN WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS_TEMP B
                ON (A.X1 = B.X1 AND A.X2 = B.X2 AND A.X3 = B.X3 AND A.X4 = B.X4 AND A.X5 = B.X5)
            )
            SELECT 
                X1, X2, X3, X4, X5,
                (
                    SELECT COUNT(*) FROM cols c 
                    WHERE diff.' || ' || 'c.column_name IS NOT NULL
                ) AS mismatch_count,
                (
                    SELECT LISTAGG(column_name, '','') WITHIN GROUP (ORDER BY column_name)
                    FROM cols c
                    WHERE diff.' || ' || 'c.column_name IS NOT NULL
                ) AS mismatch_columns,
                (
                    SELECT LISTAGG(c.column_name || '':'' || A.' || ' || 'c.column_name, '','') 
                           WITHIN GROUP (ORDER BY c.column_name)
                    FROM cols c
                    JOIN WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS A
                        ON A.X1 = diff.X1 AND A.X2 = diff.X2 AND A.X3 = diff.X3 
                       AND A.X4 = diff.X4 AND A.X5 = diff.X5
                    WHERE diff.' || ' || 'c.column_name IS NOT NULL
                ) AS mismatch_values_A,
                (
                    SELECT LISTAGG(c.column_name || '':'' || B.' || ' || 'c.column_name, '','') 
                           WITHIN GROUP (ORDER BY c.column_name)
                    FROM cols c
                    JOIN WFA_APP_USR_TALD.WD_RECRUITING_DIVERSE_INTERVIEW_PANELS_TEMP B
                        ON B.X1 = diff.X1 AND B.X2 = diff.X2 AND B.X3 = diff.X3 
                       AND B.X4 = diff.X4 AND B.X5 = diff.X5
                    WHERE diff.' || ' || 'c.column_name IS NOT NULL
                ) AS mismatch_values_B
            FROM diff
            WHERE EXISTS (
                SELECT 1 FROM cols c WHERE diff.' || ' || 'c.column_name IS NOT NULL
            )' INTO v_sql
    FROM all_tab_columns
    WHERE owner = 'WFA_APP_USR_TALD'
      AND table_name = 'WD_RECRUITING_DIVERSE_INTERVIEW_PANELS'
      AND column_name NOT IN ('X1','X2','X3','X4','X5');

    -- Execute the dynamic SQL
    EXECUTE IMMEDIATE v_sql;
END;
/
